<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Ads Integration Test</title>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #4285f4; }
    h2 { margin-top: 0; }
    h3 { margin: 10px 0; }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label { display: block; margin-bottom: 5px; font-weight: 600; }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover { background: #3367d6; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.secondary { background: #666; }
    button.secondary:hover { background: #444; }
    button.toggle-enable { background: #28a745; }
    button.toggle-enable:hover { background: #218838; }
    button.toggle-pause { background: #ffc107; color: #212529; }
    button.toggle-pause:hover { background: #e0a800; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    .item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 8px;
      border-left: 4px solid #4285f4;
      cursor: pointer;
    }
    .item:hover { background: #e9ecef; }
    .item.selected { background: #d4edda; border-left-color: #28a745; }
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item-details { font-size: 12px; color: #666; margin-top: 5px; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge.enabled { background: #d4edda; color: #155724; }
    .badge.paused { background: #fff3cd; color: #856404; }
    .badge.removed { background: #f8d7da; color: #721c24; }
    .list-container { margin-top: 10px; max-height: 300px; overflow-y: auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
      max-height: 250px;
      overflow-y: auto;
    }
    
    /* Keyword Management Styles */
    .keyword-item { display: flex; align-items: center; gap: 8px; padding: 8px; border-bottom: 1px solid #eee; }
    .keyword-text { flex: 1; font-weight: 500; }
    .match-type { padding: 2px 6px; border-radius: 3px; font-size: 11px; }
    .match-type.BROAD { background: #e3f2fd; color: #1565c0; }
    .match-type.PHRASE { background: #fff3e0; color: #e65100; }
    .match-type.EXACT { background: #e8f5e9; color: #2e7d32; }
    select.match-select { padding: 4px; font-size: 12px; border-radius: 4px; }
    
    /* Detail Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .modal-overlay.visible {
      opacity: 1;
    }
    .modal-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 700px;
      width: 90%;
      max-height: 85vh;
      overflow: hidden;
      z-index: 1001;
      transition: transform 0.25s ease;
    }
    .modal-overlay.visible .modal-container {
      transform: translate(-50%, -50%) scale(1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e9ecef;
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
    }
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      max-width: calc(100% - 40px);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .modal-header .modal-type {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.85;
      margin-bottom: 4px;
    }
    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .modal-close:hover {
      background: rgba(255,255,255,0.35);
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(85vh - 80px);
    }
    .modal-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #666;
    }
    .modal-loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e9ecef;
      border-top-color: #4285f4;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .detail-section {
      margin-bottom: 24px;
    }
    .detail-section:last-child {
      margin-bottom: 0;
    }
    .detail-section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #4285f4;
      font-weight: 700;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e9ecef;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f1f3f5;
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-label {
      font-weight: 500;
      color: #495057;
      font-size: 13px;
    }
    .detail-value {
      color: #212529;
      font-size: 13px;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }
    .detail-value.mono {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .detail-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .detail-list li {
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
      border-left: 3px solid #4285f4;
    }
    .detail-list li:last-child {
      margin-bottom: 0;
    }
    .modal-error {
      text-align: center;
      padding: 40px 20px;
      color: #dc3545;
    }
    .modal-error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <!-- Detail Modal -->
  <div class="modal-overlay" id="detail-modal" onclick="closeModalOnOverlay(event)">
    <div class="modal-container">
      <div class="modal-header">
        <div>
          <div class="modal-type" id="modal-type">Campaign</div>
          <h3 id="modal-title">Loading...</h3>
        </div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <div class="modal-loading">
          <div class="spinner"></div>
          <span>Loading details...</span>
        </div>
      </div>
    </div>
  </div>

  <h1>Google Ads Integration</h1>
  
  <div class="card">
    <h2>Step 1: Set User ID</h2>
    <label for="userId">External User ID:</label>
    <input type="text" id="userId" placeholder="e.g., user-123" value="test-user-1">
    <button onclick="saveUserId()">Save User ID</button>
    <div id="userId-status"></div>
  </div>

  <div class="card">
    <h2>Step 2: Connect Google Ads Account</h2>
    <button onclick="connectGoogleAds()">Connect Google Ads</button>
    <button class="secondary" onclick="refreshAccounts()">Refresh</button>
    <div id="connect-status"></div>
    <div id="accounts-list" class="list-container"></div>
  </div>

  <div class="card">
    <h2>Step 3: Browse Data (via Proxy)</h2>
    <button onclick="loadCustomers()" id="load-btn" disabled>Load Accessible Customers</button>
    <div id="data-status"></div>
    
    <div class="grid">
      <div>
        <h3>Customers</h3>
        <div id="customers-list" class="list-container"></div>
      </div>
      <div>
        <h3>Campaigns</h3>
        <div id="campaigns-list" class="list-container"></div>
      </div>
    </div>
    
    <div class="grid">
      <div>
        <h3>Ad Groups</h3>
        <div id="adgroups-list" class="list-container"></div>
      </div>
      <div>
        <h3>Ads</h3>
        <div id="ads-list" class="list-container"></div>
      </div>
    </div>
    
    <!-- Keywords Section -->
    <div class="card" style="margin-top: 20px;">
      <h3>Keywords</h3>
      <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Keywords belong to the Ad Group and are shared by all Ads</p>
      <div id="adgroup-keywords-list"></div>
      <div id="keywords-status" class="status"></div>
    </div>
  </div>

  <div class="card">
    <h2>Step 4: Generate Keyword Ideas</h2>
    <div class="grid">
      <div>
        <label for="keyword-input">Keywords (comma separated):</label>
        <input type="text" id="keyword-input" placeholder="e.g., digital marketing, seo">
      </div>
      <div>
        <label for="url-input">URL (optional):</label>
        <input type="text" id="url-input" placeholder="e.g., https://example.com">
      </div>
    </div>
    <div class="grid">
      <div>
        <label for="language-select">Language:</label>
        <select id="language-select">
          <option value="languageConstants/1000">English</option>
          <option value="languageConstants/1027">Hebrew</option>
          <option value="languageConstants/1004">Spanish</option>
          <option value="languageConstants/1001">German</option>
          <option value="languageConstants/1002">French</option>
        </select>
      </div>
      <div>
        <label for="geo-select">Location:</label>
        <select id="geo-select">
          <option value="geoTargetConstants/2376">Israel</option>
          <option value="geoTargetConstants/2840">United States</option>
          <option value="geoTargetConstants/2826">United Kingdom</option>
          <option value="geoTargetConstants/2276">Germany</option>
          <option value="geoTargetConstants/2250">France</option>
        </select>
      </div>
    </div>
    <button onclick="generateKeywordIdeas()" id="keyword-btn" disabled>Generate Keyword Ideas</button>
    <div id="keyword-status"></div>
    <div id="keywords-list" class="list-container" style="max-height: 400px;"></div>
  </div>

  <div class="card">
    <h2>Step 5: Create Complete Campaign</h2>
    <div class="grid">
      <div>
        <label for="campaign-name">Campaign Name:</label>
        <input type="text" id="campaign-name" placeholder="My New Campaign" required>
      </div>
      <div>
        <label for="campaign-budget">Daily Budget (USD):</label>
        <input type="number" id="campaign-budget" step="0.01" min="0.01" value="0.10" required>
      </div>
    </div>
    <div class="grid">
      <div>
        <label for="campaign-status">Status:</label>
        <select id="campaign-status">
          <option value="PAUSED" selected>PAUSED</option>
          <option value="ENABLED">ENABLED</option>
        </select>
      </div>
      <div>
        <label for="adgroup-name">Ad Group Name:</label>
        <input type="text" id="adgroup-name" placeholder="My Ad Group" required>
      </div>
    </div>
    <div>
      <label for="campaign-keywords">Keywords (comma-separated):</label>
      <textarea id="campaign-keywords" placeholder="keyword 1, keyword 2, keyword 3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;margin-bottom:15px;font-size:14px;min-height:60px;resize:vertical;"></textarea>
    </div>
    <div class="grid">
      <div>
        <label for="headline-1">Headline 1 (max 30 chars):</label>
        <input type="text" id="headline-1" maxlength="30" placeholder="Your First Headline" required>
      </div>
      <div>
        <label for="headline-2">Headline 2 (max 30 chars):</label>
        <input type="text" id="headline-2" maxlength="30" placeholder="Your Second Headline" required>
      </div>
    </div>
    <div>
      <label for="headline-3">Headline 3 (max 30 chars):</label>
      <input type="text" id="headline-3" maxlength="30" placeholder="Your Third Headline" required>
    </div>
    <div class="grid">
      <div>
        <label for="description-1">Description 1 (max 90 chars):</label>
        <input type="text" id="description-1" maxlength="90" placeholder="Your first description goes here" required>
      </div>
      <div>
        <label for="description-2">Description 2 (max 90 chars):</label>
        <input type="text" id="description-2" maxlength="90" placeholder="Your second description goes here" required>
      </div>
    </div>
    <div>
      <label for="final-url">Final URL:</label>
      <input type="url" id="final-url" placeholder="https://example.com" required>
    </div>
    <button onclick="createCompleteCampaign()" id="create-campaign-btn" disabled>Create Complete Campaign</button>
    <div id="create-campaign-status"></div>
  </div>

  <div class="card">
    <h2>Raw API Response</h2>
    <pre id="raw-response">Click "Load Accessible Customers" to start...</pre>
  </div>

  <script>
    let currentUserId = 'test-user-1';
    let selectedAccountId = null;
    let selectedCustomerId = null;
    let selectedCampaignId = null;
    let selectedAdGroupId = null;

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `status ${type}`;
      el.innerHTML = message;
    }

    function formatStatus(status) {
      const s = (status || '').toString().toUpperCase();
      if (s.includes('ENABLED')) return '<span class="badge enabled">ENABLED</span>';
      if (s.includes('PAUSED')) return '<span class="badge paused">PAUSED</span>';
      if (s.includes('REMOVED')) return '<span class="badge removed">REMOVED</span>';
      return `<span class="badge">${s || 'UNKNOWN'}</span>`;
    }

    function formatMicros(micros) {
      if (!micros) return 'N/A';
      return '$' + (parseInt(micros) / 1000000).toFixed(2);
    }

    function showRawResponse(data) {
      document.getElementById('raw-response').textContent = JSON.stringify(data, null, 2);
    }

    function saveUserId() {
      currentUserId = document.getElementById('userId').value.trim();
      if (!currentUserId) {
        showStatus('userId-status', 'Please enter a user ID', 'error');
        return;
      }
      showStatus('userId-status', `User ID set to: ${currentUserId}`, 'success');
      selectedAccountId = null;
      selectedCustomerId = null;
      clearAllLists();
      refreshAccounts();
    }

    function clearAllLists() {
      ['accounts-list', 'customers-list', 'campaigns-list', 'adgroups-list', 'ads-list', 'adgroup-keywords-list'].forEach(id => {
        document.getElementById(id).innerHTML = '';
      });
    }

    async function connectGoogleAds() {
      if (!currentUserId) {
        showStatus('connect-status', 'Please set a user ID first', 'error');
        return;
      }

      try {
        showStatus('connect-status', 'Getting connect token...', 'info');
        
        const tokenResponse = await fetch('/api/connect-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ externalUserId: currentUserId }),
        });
        
        if (!tokenResponse.ok) throw new Error((await tokenResponse.json()).error || 'Failed to get token');
        
        const { connectLinkUrl } = await tokenResponse.json();
        showStatus('connect-status', 'Opening Google Ads connection popup...', 'info');
        
        const popup = window.open(connectLinkUrl, 'google-ads-connect', 
          `width=600,height=700,left=${(window.innerWidth-600)/2},top=${(window.innerHeight-700)/2}`);
        
        window.addEventListener('message', function handler(event) {
          if (event.data?.type === 'google-ads-connected') {
            window.removeEventListener('message', handler);
            showStatus('connect-status', 'Google Ads connected!', 'success');
            selectedAccountId = event.data.accountId || null;
            refreshAccounts();
          }
        });
        
        const checkPopup = setInterval(() => {
          if (popup.closed) {
            clearInterval(checkPopup);
            setTimeout(refreshAccounts, 1000);
          }
        }, 500);
      } catch (error) {
        showStatus('connect-status', `Error: ${error.message}`, 'error');
      }
    }

    async function refreshAccounts() {
      if (!currentUserId) return;

      try {
        const response = await fetch(`/api/accounts?externalUserId=${encodeURIComponent(currentUserId)}`);
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        const accounts = data.data || [];
        const listEl = document.getElementById('accounts-list');
        
        if (accounts.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No Google Ads accounts connected.</p>';
          document.getElementById('load-btn').disabled = true;
          return;
        }
        
        listEl.innerHTML = accounts.map(acc => `
          <div class="item ${selectedAccountId === acc.id ? 'selected' : ''}" onclick="selectAccount('${acc.id}')">
            <div class="item-header">
              <strong>${acc.name || 'Google Ads Account'}</strong>
              ${selectedAccountId === acc.id ? '<span class="badge enabled">Selected</span>' : ''}
            </div>
            <div class="item-details">ID: ${acc.id}</div>
          </div>
        `).join('');
        
        if (!selectedAccountId && accounts.length > 0) selectAccount(accounts[0].id);
      } catch (error) {
        showStatus('connect-status', `Error: ${error.message}`, 'error');
      }
    }

    function selectAccount(accountId) {
      selectedAccountId = accountId;
      selectedCustomerId = null;
      clearAllLists();
      refreshAccounts();
      document.getElementById('load-btn').disabled = false;
      showStatus('connect-status', `Selected account: ${accountId}`, 'success');
    }

    async function loadCustomers() {
      if (!selectedAccountId) {
        showStatus('data-status', 'Select an account first', 'error');
        return;
      }

      try {
        showStatus('data-status', 'Loading accessible customers...', 'info');
        
        const response = await fetch(
          `/api/customers?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}`
        );
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const resourceNames = data.resourceNames || [];
        const listEl = document.getElementById('customers-list');
        
        if (resourceNames.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No customers found.</p>';
          showStatus('data-status', 'No customers found', 'info');
          return;
        }
        
        listEl.innerHTML = resourceNames.map(rn => {
          const customerId = rn.replace('customers/', '');
          return `
            <div class="item ${selectedCustomerId === customerId ? 'selected' : ''}" onclick="selectCustomer('${customerId}')">
              <div class="item-header"><strong>Customer ${customerId}</strong></div>
              <div class="item-details">${rn}</div>
            </div>
          `;
        }).join('');
        
        showStatus('data-status', `Found ${resourceNames.length} customer(s). Click one to load campaigns.`, 'success');
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function loadCampaigns(customerId) {
      try {
        showStatus('data-status', 'Loading campaigns...', 'info');
        
        const response = await fetch(
          `/api/campaigns?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}&customerId=${customerId}`
        );
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const results = data.results || [];
        const listEl = document.getElementById('campaigns-list');
        
        if (results.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No campaigns found.</p>';
          showStatus('data-status', 'No campaigns found', 'info');
          return;
        }
        
        listEl.innerHTML = results.map(r => {
          const c = r.campaign || {};
          const b = r.campaignBudget || {};
          const escapedName = (c.name || 'Unnamed').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          return `
            <div class="item ${selectedCampaignId === c.id ? 'selected' : ''}" onclick="selectCampaign('${c.id}')">
              <div class="item-header">
                <strong>${c.name || 'Unnamed'}</strong>
                <span>
                  ${formatStatus(c.status)}
                  <button onclick="event.stopPropagation(); showCampaignDetails('${c.id}', '${escapedName}')" style="margin-left:8px;padding:4px 10px;font-size:11px;">Details</button>
                  <button class="${c.status === 'ENABLED' ? 'toggle-pause' : 'toggle-enable'}" onclick="event.stopPropagation(); toggleCampaignStatus('${c.id}', '${c.status}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">${c.status === 'ENABLED' ? 'Pause' : 'Enable'}</button>
                  <button class="danger" onclick="event.stopPropagation(); deleteCampaign('${c.id}', '${escapedName}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">Delete</button>
                </span>
              </div>
              <div class="item-details">
                ID: ${c.id || 'N/A'}<br>
                Type: ${c.advertisingChannelType || 'N/A'}<br>
                Budget: ${formatMicros(b.amountMicros)}/day
              </div>
            </div>
          `;
        }).join('');
        
        showStatus('data-status', `Found ${results.length} campaign(s). Click one to load ad groups.`, 'success');
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function selectCampaign(campaignId) {
      selectedCampaignId = campaignId;
      selectedAdGroupId = null;
      document.getElementById('adgroups-list').innerHTML = '';
      document.getElementById('ads-list').innerHTML = '';
      
      document.querySelectorAll('#campaigns-list .item').forEach(el => {
        el.classList.toggle('selected', el.textContent.includes(`ID: ${campaignId}`));
      });
      
      await loadAdGroups(campaignId);
    }

    async function loadAdGroups(campaignId) {
      try {
        showStatus('data-status', 'Loading ad groups...', 'info');
        
        const response = await fetch(
          `/api/ad-groups?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}&customerId=${selectedCustomerId}&campaignId=${campaignId}`
        );
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const results = data.results || [];
        const listEl = document.getElementById('adgroups-list');
        
        if (results.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No ad groups found.</p>';
          showStatus('data-status', 'No ad groups found', 'info');
          return;
        }
        
        listEl.innerHTML = results.map(r => {
          const ag = r.adGroup || {};
          const escapedName = (ag.name || 'Unnamed').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          return `
            <div class="item ${selectedAdGroupId === ag.id ? 'selected' : ''}" onclick="selectAdGroup('${ag.id}')">
              <div class="item-header">
                <strong>${ag.name || 'Unnamed'}</strong>
                <span>
                  ${formatStatus(ag.status)}
                  <button onclick="event.stopPropagation(); showAdGroupDetails('${ag.id}', '${escapedName}')" style="margin-left:8px;padding:4px 10px;font-size:11px;">Details</button>
                  <button class="${ag.status === 'ENABLED' ? 'toggle-pause' : 'toggle-enable'}" onclick="event.stopPropagation(); toggleAdGroupStatus('${ag.id}', '${ag.status}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">${ag.status === 'ENABLED' ? 'Pause' : 'Enable'}</button>
                  <button class="danger" onclick="event.stopPropagation(); deleteAdGroup('${ag.id}', '${escapedName}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">Delete</button>
                </span>
              </div>
              <div class="item-details">
                ID: ${ag.id || 'N/A'}<br>
                Type: ${ag.type || 'N/A'}<br>
                CPC: ${formatMicros(ag.cpcBidMicros)}
              </div>
            </div>
          `;
        }).join('');
        
        showStatus('data-status', `Found ${results.length} ad group(s). Click one to load ads.`, 'success');
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function selectAdGroup(adGroupId) {
      selectedAdGroupId = adGroupId;
      document.getElementById('ads-list').innerHTML = '';
      document.getElementById('adgroup-keywords-list').innerHTML = '';
      
      document.querySelectorAll('#adgroups-list .item').forEach(el => {
        el.classList.toggle('selected', el.textContent.includes(`ID: ${adGroupId}`));
      });
      
      await loadAds(adGroupId);
      await loadKeywords(adGroupId);
    }

    async function loadAds(adGroupId) {
      try {
        showStatus('data-status', 'Loading ads...', 'info');
        
        const response = await fetch(
          `/api/ads?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}&customerId=${selectedCustomerId}&adGroupId=${adGroupId}`
        );
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const results = data.results || [];
        const listEl = document.getElementById('ads-list');
        
        if (results.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No ads found.</p>';
          showStatus('data-status', 'No ads found', 'info');
          return;
        }
        
        listEl.innerHTML = results.map(r => {
          const aga = r.adGroupAd || {};
          const ad = aga.ad || {};
          const rsa = ad.responsiveSearchAd || {};
          const headlines = (rsa.headlines || []).map(h => h.text).slice(0,2).join(', ');
          return `
            <div class="item">
              <div class="item-header">
                <strong>Ad ${ad.id || 'N/A'}</strong>
                <span>
                  ${formatStatus(aga.status)}
                  <button onclick="showAdDetails('${ad.id}', '${aga.resourceName || ''}')" style="margin-left:8px;padding:4px 10px;font-size:11px;">Details</button>
                  <button class="${aga.status === 'ENABLED' ? 'toggle-pause' : 'toggle-enable'}" onclick="toggleAdStatus('${ad.id}', '${aga.status}', '${selectedAdGroupId}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">${aga.status === 'ENABLED' ? 'Pause' : 'Enable'}</button>
                  <button class="danger" onclick="deleteAd('${ad.id}', '${selectedAdGroupId}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">Delete</button>
                </span>
              </div>
              <div class="item-details">
                Type: ${ad.type || 'N/A'}<br>
                Headlines: ${headlines || 'N/A'}<br>
                URLs: ${(ad.finalUrls || []).slice(0,1).join(', ') || 'N/A'}
              </div>
            </div>
          `;
        }).join('');
        
        showStatus('data-status', `Found ${results.length} ad(s)`, 'success');
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function loadKeywords(adGroupId) {
      if (!adGroupId) return;
      
      const keywordsList = document.getElementById('adgroup-keywords-list');
      keywordsList.innerHTML = '<p>Loading keywords...</p>';
      
      try {
        const response = await fetch(`/api/keywords?externalUserId=${currentUserId}&accountId=${selectedAccountId}&customerId=${selectedCustomerId}&adGroupId=${adGroupId}`);
        const data = await response.json();
        
        if (!data.results || data.results.length === 0) {
          keywordsList.innerHTML = '<p style="color:#666;">No keywords found for this ad group</p>';
          return;
        }
        
        keywordsList.innerHTML = data.results.map(r => {
          const kw = r.adGroupCriterion;
          const criterionId = kw.criterionId;
          const text = kw.keyword?.text || 'Unknown';
          const matchType = kw.keyword?.matchType || 'BROAD';
          const status = kw.status || 'ENABLED';
          const resourceName = kw.resourceName;
          const escapedText = text.replace(/'/g, "\\'");
          
          return `
            <div class="keyword-item" data-criterion-id="${criterionId}">
              <span class="keyword-text">${text}</span>
              <span class="match-type ${matchType}">${matchType}</span>
              <select class="match-select" onchange="updateKeywordMatchType('${resourceName}', this.value, '${escapedText}')">
                <option value="BROAD" ${matchType === 'BROAD' ? 'selected' : ''}>Broad</option>
                <option value="PHRASE" ${matchType === 'PHRASE' ? 'selected' : ''}>Phrase</option>
                <option value="EXACT" ${matchType === 'EXACT' ? 'selected' : ''}>Exact</option>
              </select>
              <button class="${status === 'ENABLED' ? 'toggle-pause' : 'toggle-enable'}" 
                      onclick="toggleKeywordStatus('${resourceName}', '${status}')"
                      style="padding:4px 8px;font-size:11px;">
                ${status === 'ENABLED' ? 'Pause' : 'Enable'}
              </button>
              <button class="danger" onclick="deleteKeyword('${resourceName}', '${escapedText}')" 
                      style="padding:4px 8px;font-size:11px;">
                Remove
              </button>
            </div>
          `;
        }).join('');
      } catch (error) {
        keywordsList.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    }

    async function updateKeywordMatchType(resourceName, newMatchType, keywordText) {
      try {
        showStatus('keywords-status', 'Updating match type...', 'info');
        
        await fetch(`/api/customers/${selectedCustomerId}/adGroupCriteria/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{ remove: resourceName }]
          })
        });
        
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupCriteria/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              create: {
                adGroup: `customers/${selectedCustomerId}/adGroups/${selectedAdGroupId}`,
                status: 'ENABLED',
                keyword: {
                  text: keywordText,
                  matchType: newMatchType
                }
              }
            }]
          })
        });
        
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('keywords-status', `Match type updated to ${newMatchType}`, 'success');
        await loadKeywords(selectedAdGroupId);
      } catch (error) {
        showStatus('keywords-status', `Error: ${error.message}`, 'error');
        await loadKeywords(selectedAdGroupId);
      }
    }

    async function toggleKeywordStatus(resourceName, currentStatus) {
      const newStatus = currentStatus === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      try {
        showStatus('keywords-status', 'Updating keyword status...', 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupCriteria/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              update: {
                resourceName: resourceName,
                status: newStatus
              },
              updateMask: 'status'
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('keywords-status', `Keyword ${newStatus.toLowerCase()}`, 'success');
        await loadKeywords(selectedAdGroupId);
      } catch (error) {
        showStatus('keywords-status', `Error: ${error.message}`, 'error');
      }
    }

    async function deleteKeyword(resourceName, keywordText) {
      if (!confirm(`Remove keyword "${keywordText}"?`)) return;
      
      try {
        showStatus('keywords-status', 'Removing keyword...', 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupCriteria/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{ remove: resourceName }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('keywords-status', 'Keyword removed', 'success');
        await loadKeywords(selectedAdGroupId);
      } catch (error) {
        showStatus('keywords-status', `Error: ${error.message}`, 'error');
      }
    }

    async function generateKeywordIdeas() {
      if (!selectedAccountId || !selectedCustomerId) {
        showStatus('keyword-status', 'Please select a customer first', 'error');
        return;
      }

      const keywordsInput = document.getElementById('keyword-input').value.trim();
      const urlInput = document.getElementById('url-input').value.trim();
      
      if (!keywordsInput && !urlInput) {
        showStatus('keyword-status', 'Please enter at least one keyword or URL', 'error');
        return;
      }

      const keywords = keywordsInput ? keywordsInput.split(',').map(k => k.trim()).filter(k => k) : [];
      const language = document.getElementById('language-select').value;
      const geo = document.getElementById('geo-select').value;

      try {
        showStatus('keyword-status', 'Generating keyword ideas...', 'info');
        
        const body = {
          externalUserId: currentUserId,
          accountId: selectedAccountId,
          language,
          geoTargetConstants: [geo],
        };
        
        if (keywords.length) body.keywords = keywords;
        if (urlInput) body.url = urlInput;

        const response = await fetch(`/api/customers/${selectedCustomerId}/generateKeywordIdeas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const results = data.results || [];
        const listEl = document.getElementById('keywords-list');
        
        if (results.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No keyword ideas found.</p>';
          showStatus('keyword-status', 'No keyword ideas found', 'info');
          return;
        }
        
        listEl.innerHTML = results.slice(0, 50).map(r => {
          const kw = r.keywordIdeaMetrics || {};
          const text = r.text || 'N/A';
          const competition = kw.competition || 'N/A';
          const avgSearches = kw.avgMonthlySearches || 'N/A';
          const lowBid = kw.lowTopOfPageBidMicros ? formatMicros(kw.lowTopOfPageBidMicros) : 'N/A';
          const highBid = kw.highTopOfPageBidMicros ? formatMicros(kw.highTopOfPageBidMicros) : 'N/A';
          return `
            <div class="item">
              <div class="item-header">
                <strong>${text}</strong>
                <span class="badge ${competition.toLowerCase()}">${competition}</span>
              </div>
              <div class="item-details">
                Avg Monthly Searches: ${avgSearches}<br>
                Bid Range: ${lowBid} - ${highBid}
              </div>
            </div>
          `;
        }).join('');
        
        showStatus('keyword-status', `Found ${results.length} keyword ideas (showing first 50)`, 'success');
      } catch (error) {
        showStatus('keyword-status', `Error: ${error.message}`, 'error');
      }
    }

    function selectCustomer(customerId) {
      selectedCustomerId = customerId;
      selectedCampaignId = null;
      selectedAdGroupId = null;
      document.getElementById('campaigns-list').innerHTML = '';
      document.getElementById('adgroups-list').innerHTML = '';
      document.getElementById('ads-list').innerHTML = '';
      document.getElementById('keywords-list').innerHTML = '';
      
      document.querySelectorAll('#customers-list .item').forEach(el => {
        el.classList.toggle('selected', el.textContent.includes(customerId));
      });
      
      document.getElementById('keyword-btn').disabled = false;
      document.getElementById('create-campaign-btn').disabled = false;
      loadCampaigns(customerId);
    }

    async function createCompleteCampaign() {
      if (!selectedAccountId || !selectedCustomerId) {
        showStatus('create-campaign-status', 'Please select a customer first', 'error');
        return;
      }

      const campaignName = document.getElementById('campaign-name').value.trim();
      const budgetUsd = parseFloat(document.getElementById('campaign-budget').value);
      const status = document.getElementById('campaign-status').value;
      const adGroupName = document.getElementById('adgroup-name').value.trim();
      const keywordsText = document.getElementById('campaign-keywords').value.trim();
      const headline1 = document.getElementById('headline-1').value.trim();
      const headline2 = document.getElementById('headline-2').value.trim();
      const headline3 = document.getElementById('headline-3').value.trim();
      const description1 = document.getElementById('description-1').value.trim();
      const description2 = document.getElementById('description-2').value.trim();
      const finalUrl = document.getElementById('final-url').value.trim();

      if (!campaignName) {
        showStatus('create-campaign-status', 'Campaign name is required', 'error');
        return;
      }
      if (!budgetUsd || budgetUsd < 0.01) {
        showStatus('create-campaign-status', 'Budget must be at least $0.01', 'error');
        return;
      }
      if (!adGroupName) {
        showStatus('create-campaign-status', 'Ad group name is required', 'error');
        return;
      }
      if (!headline1 || !headline2 || !headline3) {
        showStatus('create-campaign-status', 'All three headlines are required', 'error');
        return;
      }
      if (headline1.length > 30 || headline2.length > 30 || headline3.length > 30) {
        showStatus('create-campaign-status', 'Headlines must be 30 characters or less', 'error');
        return;
      }
      if (!description1 || !description2) {
        showStatus('create-campaign-status', 'Both descriptions are required', 'error');
        return;
      }
      if (description1.length > 90 || description2.length > 90) {
        showStatus('create-campaign-status', 'Descriptions must be 90 characters or less', 'error');
        return;
      }
      if (!finalUrl) {
        showStatus('create-campaign-status', 'Final URL is required', 'error');
        return;
      }

      const keywords = keywordsText ? keywordsText.split(',').map(k => k.trim()).filter(k => k) : [];
      const budgetInMicros = Math.round(budgetUsd * 1000000);

      const btn = document.getElementById('create-campaign-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        showStatus('create-campaign-status', 'Creating campaign...', 'info');

        const response = await fetch(`/api/customers/${selectedCustomerId}/createCompleteCampaign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            campaignName: campaignName,
            budgetAmountMicros: budgetInMicros,
            status: status,
            adGroupName: adGroupName,
            keywords: keywords,
            adHeadlines: [headline1, headline2, headline3],
            adDescriptions: [description1, description2],
            finalUrl: finalUrl
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to create campaign');
        }

        const data = await response.json();
        showRawResponse(data);

        showStatus('create-campaign-status', 'Campaign created successfully!', 'success');

        document.getElementById('campaign-name').value = '';
        document.getElementById('campaign-budget').value = '0.10';
        document.getElementById('campaign-status').value = 'PAUSED';
        document.getElementById('adgroup-name').value = '';
        document.getElementById('campaign-keywords').value = '';
        document.getElementById('headline-1').value = '';
        document.getElementById('headline-2').value = '';
        document.getElementById('headline-3').value = '';
        document.getElementById('description-1').value = '';
        document.getElementById('description-2').value = '';
        document.getElementById('final-url').value = '';

        if (selectedCustomerId) {
          await loadCampaigns(selectedCustomerId);
        }
      } catch (error) {
        showStatus('create-campaign-status', `Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    document.addEventListener('DOMContentLoaded', saveUserId);

    function openModal(type, title) {
      const modal = document.getElementById('detail-modal');
      document.getElementById('modal-type').textContent = type;
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-body').innerHTML = `
        <div class="modal-loading">
          <div class="spinner"></div>
          <span>Loading details...</span>
        </div>
      `;
      modal.style.display = 'block';
      requestAnimationFrame(() => modal.classList.add('visible'));
    }

    function closeModal() {
      const modal = document.getElementById('detail-modal');
      modal.classList.remove('visible');
      setTimeout(() => modal.style.display = 'none', 250);
    }

    function closeModalOnOverlay(event) {
      if (event.target.id === 'detail-modal') closeModal();
    }

    function showModalError(message) {
      document.getElementById('modal-body').innerHTML = `
        <div class="modal-error">
          <div class="modal-error-icon">⚠️</div>
          <p>${message}</p>
        </div>
      `;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      if (dateStr.length === 8) {
        return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
      }
      return dateStr;
    }

    function formatBoolean(val) {
      if (val === true) return 'Yes';
      if (val === false) return 'No';
      return 'N/A';
    }

    function renderDetailSection(title, rows) {
      const validRows = rows.filter(r => r.value !== undefined && r.value !== null && r.value !== '');
      if (validRows.length === 0) return '';
      return `
        <div class="detail-section">
          <div class="detail-section-title">${title}</div>
          ${validRows.map(r => `
            <div class="detail-row">
              <span class="detail-label">${r.label}</span>
              <span class="detail-value ${r.mono ? 'mono' : ''}">${r.value}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderDetailList(title, items) {
      if (!items || items.length === 0) return '';
      return `
        <div class="detail-section">
          <div class="detail-section-title">${title}</div>
          <ul class="detail-list">
            ${items.map(item => `<li>${item}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    async function executeGAQL(query) {
      const response = await fetch(
        `/api/customers/${selectedCustomerId}/googleAds:search?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
        }
      );
      if (!response.ok) throw new Error((await response.json()).error || 'API request failed');
      return response.json();
    }

    async function showCampaignDetails(campaignId, campaignName) {
      openModal('Campaign', campaignName || `Campaign ${campaignId}`);
      try {
        const query = `
          SELECT 
            campaign.id,
            campaign.name,
            campaign.status,
            campaign.start_date,
            campaign.end_date,
            campaign.advertising_channel_type,
            campaign.advertising_channel_sub_type,
            campaign.bidding_strategy_type,
            campaign.network_settings.target_google_search,
            campaign.network_settings.target_search_network,
            campaign.network_settings.target_content_network,
            campaign.network_settings.target_partner_search_network,
            campaign.geo_target_type_setting.positive_geo_target_type,
            campaign.geo_target_type_setting.negative_geo_target_type,
            campaign.target_spend.target_spend_micros,
            campaign.url_custom_parameters,
            campaign_budget.amount_micros,
            campaign_budget.delivery_method,
            campaign_budget.period,
            campaign_budget.type,
            campaign_budget.explicitly_shared
          FROM campaign
          WHERE campaign.id = ${campaignId}
        `;
        const data = await executeGAQL(query);
        const result = (data.results || [])[0];
        
        if (!result) {
          showModalError('Campaign not found');
          return;
        }
        
        const c = result.campaign || {};
        const b = result.campaignBudget || {};
        const ns = c.networkSettings || {};
        const geo = c.geoTargetTypeSetting || {};
        const customParams = c.urlCustomParameters || [];
        
        let html = renderDetailSection('Basic Information', [
          { label: 'Campaign ID', value: c.id, mono: true },
          { label: 'Name', value: c.name },
          { label: 'Status', value: formatStatus(c.status) },
          { label: 'Start Date', value: formatDate(c.startDate) },
          { label: 'End Date', value: formatDate(c.endDate) || 'No end date' },
        ]);
        
        html += renderDetailSection('Channel Settings', [
          { label: 'Channel Type', value: c.advertisingChannelType },
          { label: 'Channel Sub-Type', value: c.advertisingChannelSubType },
          { label: 'Bidding Strategy', value: c.biddingStrategyType },
        ]);
        
        html += renderDetailSection('Budget', [
          { label: 'Daily Budget', value: formatMicros(b.amountMicros) },
          { label: 'Delivery Method', value: b.deliveryMethod },
          { label: 'Budget Period', value: b.period },
          { label: 'Budget Type', value: b.type },
          { label: 'Shared Budget', value: formatBoolean(b.explicitlyShared) },
          { label: 'Target Spend', value: c.targetSpend?.targetSpendMicros ? formatMicros(c.targetSpend.targetSpendMicros) : null },
        ]);
        
        html += renderDetailSection('Network Settings', [
          { label: 'Google Search', value: formatBoolean(ns.targetGoogleSearch) },
          { label: 'Search Network', value: formatBoolean(ns.targetSearchNetwork) },
          { label: 'Content Network', value: formatBoolean(ns.targetContentNetwork) },
          { label: 'Partner Search Network', value: formatBoolean(ns.targetPartnerSearchNetwork) },
        ]);
        
        html += renderDetailSection('Geo Target Settings', [
          { label: 'Positive Geo Target Type', value: geo.positiveGeoTargetType },
          { label: 'Negative Geo Target Type', value: geo.negativeGeoTargetType },
        ]);
        
        if (customParams.length > 0) {
          const params = customParams.map(p => `{${p.key}} = ${p.value}`);
          html += renderDetailList('URL Custom Parameters', params);
        }
        
        document.getElementById('modal-body').innerHTML = html || '<p>No additional details available.</p>';
      } catch (error) {
        showModalError(error.message);
      }
    }

    async function showAdGroupDetails(adGroupId, adGroupName) {
      openModal('Ad Group', adGroupName || `Ad Group ${adGroupId}`);
      try {
        const query = `
          SELECT 
            ad_group.id,
            ad_group.name,
            ad_group.status,
            ad_group.type,
            ad_group.cpc_bid_micros,
            ad_group.cpm_bid_micros,
            ad_group.cpv_bid_micros,
            ad_group.target_cpa_micros,
            ad_group.target_roas,
            ad_group.effective_target_cpa_micros,
            ad_group.effective_target_roas,
            ad_group.percent_cpc_bid_micros,
            ad_group.display_custom_bid_dimension,
            ad_group.final_url_suffix,
            ad_group.tracking_url_template,
            campaign.id,
            campaign.name
          FROM ad_group
          WHERE ad_group.id = ${adGroupId}
        `;
        const data = await executeGAQL(query);
        const result = (data.results || [])[0];
        
        if (!result) {
          showModalError('Ad Group not found');
          return;
        }
        
        const ag = result.adGroup || {};
        const campaign = result.campaign || {};
        
        let html = renderDetailSection('Basic Information', [
          { label: 'Ad Group ID', value: ag.id, mono: true },
          { label: 'Name', value: ag.name },
          { label: 'Status', value: formatStatus(ag.status) },
          { label: 'Type', value: ag.type },
          { label: 'Campaign', value: campaign.name },
          { label: 'Campaign ID', value: campaign.id, mono: true },
        ]);
        
        html += renderDetailSection('Bidding', [
          { label: 'CPC Bid', value: ag.cpcBidMicros ? formatMicros(ag.cpcBidMicros) : null },
          { label: 'CPM Bid', value: ag.cpmBidMicros ? formatMicros(ag.cpmBidMicros) : null },
          { label: 'CPV Bid', value: ag.cpvBidMicros ? formatMicros(ag.cpvBidMicros) : null },
          { label: 'Target CPA', value: ag.targetCpaMicros ? formatMicros(ag.targetCpaMicros) : null },
          { label: 'Effective Target CPA', value: ag.effectiveTargetCpaMicros ? formatMicros(ag.effectiveTargetCpaMicros) : null },
          { label: 'Target ROAS', value: ag.targetRoas ? `${(ag.targetRoas * 100).toFixed(0)}%` : null },
          { label: 'Effective Target ROAS', value: ag.effectiveTargetRoas ? `${(ag.effectiveTargetRoas * 100).toFixed(0)}%` : null },
          { label: 'Percent CPC Bid', value: ag.percentCpcBidMicros ? formatMicros(ag.percentCpcBidMicros) : null },
        ]);
        
        html += renderDetailSection('Tracking & Display', [
          { label: 'Display Custom Bid Dimension', value: ag.displayCustomBidDimension },
          { label: 'Final URL Suffix', value: ag.finalUrlSuffix },
          { label: 'Tracking URL Template', value: ag.trackingUrlTemplate },
        ]);
        
        document.getElementById('modal-body').innerHTML = html || '<p>No additional details available.</p>';
      } catch (error) {
        showModalError(error.message);
      }
    }

    async function showAdDetails(adId, adGroupAdResourceName) {
      openModal('Ad', `Ad ${adId}`);
      try {
        const query = `
          SELECT 
            ad_group_ad.ad.id,
            ad_group_ad.ad.type,
            ad_group_ad.ad.final_urls,
            ad_group_ad.ad.final_mobile_urls,
            ad_group_ad.ad.display_url,
            ad_group_ad.ad.tracking_url_template,
            ad_group_ad.ad.url_custom_parameters,
            ad_group_ad.ad.responsive_search_ad.headlines,
            ad_group_ad.ad.responsive_search_ad.descriptions,
            ad_group_ad.ad.responsive_search_ad.path1,
            ad_group_ad.ad.responsive_search_ad.path2,
            ad_group_ad.ad.expanded_text_ad.headline_part1,
            ad_group_ad.ad.expanded_text_ad.headline_part2,
            ad_group_ad.ad.expanded_text_ad.headline_part3,
            ad_group_ad.ad.expanded_text_ad.description,
            ad_group_ad.ad.expanded_text_ad.description2,
            ad_group_ad.ad.expanded_text_ad.path1,
            ad_group_ad.ad.expanded_text_ad.path2,
            ad_group_ad.status,
            ad_group_ad.policy_summary.approval_status,
            ad_group_ad.policy_summary.review_status,
            ad_group.id,
            ad_group.name,
            campaign.id,
            campaign.name
          FROM ad_group_ad
          WHERE ad_group_ad.ad.id = ${adId}
        `;
        const data = await executeGAQL(query);
        const result = (data.results || [])[0];
        
        if (!result) {
          showModalError('Ad not found');
          return;
        }
        
        const aga = result.adGroupAd || {};
        const ad = aga.ad || {};
        const rsa = ad.responsiveSearchAd || {};
        const eta = ad.expandedTextAd || {};
        const policy = aga.policySummary || {};
        const adGroup = result.adGroup || {};
        const campaign = result.campaign || {};
        const customParams = ad.urlCustomParameters || [];
        
        let html = renderDetailSection('Basic Information', [
          { label: 'Ad ID', value: ad.id, mono: true },
          { label: 'Ad Type', value: ad.type },
          { label: 'Status', value: formatStatus(aga.status) },
          { label: 'Ad Group', value: adGroup.name },
          { label: 'Ad Group ID', value: adGroup.id, mono: true },
          { label: 'Campaign', value: campaign.name },
          { label: 'Campaign ID', value: campaign.id, mono: true },
        ]);
        
        html += renderDetailSection('Policy Status', [
          { label: 'Approval Status', value: policy.approvalStatus },
          { label: 'Review Status', value: policy.reviewStatus },
        ]);
        
        const headlines = (rsa.headlines || []).map(h => h.text).filter(Boolean);
        if (headlines.length > 0) {
          html += renderDetailList('Headlines (Responsive Search Ad)', headlines);
        }
        
        const descriptions = (rsa.descriptions || []).map(d => d.text).filter(Boolean);
        if (descriptions.length > 0) {
          html += renderDetailList('Descriptions (Responsive Search Ad)', descriptions);
        }
        
        if (rsa.path1 || rsa.path2) {
          html += renderDetailSection('Display Path (Responsive Search Ad)', [
            { label: 'Path 1', value: rsa.path1 },
            { label: 'Path 2', value: rsa.path2 },
          ]);
        }
        
        const etaHeadlines = [eta.headlinePart1, eta.headlinePart2, eta.headlinePart3].filter(Boolean);
        if (etaHeadlines.length > 0) {
          html += renderDetailList('Headlines (Expanded Text Ad)', etaHeadlines);
        }
        
        const etaDescriptions = [eta.description, eta.description2].filter(Boolean);
        if (etaDescriptions.length > 0) {
          html += renderDetailList('Descriptions (Expanded Text Ad)', etaDescriptions);
        }
        
        if (eta.path1 || eta.path2) {
          html += renderDetailSection('Display Path (Expanded Text Ad)', [
            { label: 'Path 1', value: eta.path1 },
            { label: 'Path 2', value: eta.path2 },
          ]);
        }
        
        const finalUrls = ad.finalUrls || [];
        if (finalUrls.length > 0) {
          html += renderDetailList('Final URLs', finalUrls);
        }
        
        const finalMobileUrls = ad.finalMobileUrls || [];
        if (finalMobileUrls.length > 0) {
          html += renderDetailList('Final Mobile URLs', finalMobileUrls);
        }
        
        html += renderDetailSection('Tracking & Display', [
          { label: 'Display URL', value: ad.displayUrl },
          { label: 'Tracking URL Template', value: ad.trackingUrlTemplate },
        ]);
        
        if (customParams.length > 0) {
          const params = customParams.map(p => `{${p.key}} = ${p.value}`);
          html += renderDetailList('URL Custom Parameters', params);
        }
        
        document.getElementById('modal-body').innerHTML = html || '<p>No additional details available.</p>';
      } catch (error) {
        showModalError(error.message);
      }
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });

    async function toggleCampaignStatus(campaignId, currentStatus) {
      const newStatus = currentStatus === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      try {
        showStatus('data-status', `Updating campaign status...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/campaigns/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              update: {
                resourceName: `customers/${selectedCustomerId}/campaigns/${campaignId}`,
                status: newStatus
              },
              updateMask: 'status'
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Campaign ${newStatus.toLowerCase()}`, 'success');
        await loadCampaigns(selectedCustomerId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function toggleAdGroupStatus(adGroupId, currentStatus) {
      const newStatus = currentStatus === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      try {
        showStatus('data-status', `Updating ad group status...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroups/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              update: {
                resourceName: `customers/${selectedCustomerId}/adGroups/${adGroupId}`,
                status: newStatus
              },
              updateMask: 'status'
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Ad group ${newStatus.toLowerCase()}`, 'success');
        await loadAdGroups(selectedCampaignId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function toggleAdStatus(adId, currentStatus, adGroupId) {
      const newStatus = currentStatus === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      try {
        showStatus('data-status', `Updating ad status...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupAds/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              update: {
                resourceName: `customers/${selectedCustomerId}/adGroupAds/${adGroupId}~${adId}`,
                status: newStatus
              },
              updateMask: 'status'
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Ad ${newStatus.toLowerCase()}`, 'success');
        await loadAds(selectedAdGroupId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function deleteCampaign(campaignId, campaignName) {
      if (!confirm(`Are you sure you want to delete campaign "${campaignName}"?\n\nThis will also delete all ad groups and ads within this campaign.`)) {
        return;
      }
      try {
        showStatus('data-status', `Deleting campaign...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/campaigns/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              remove: `customers/${selectedCustomerId}/campaigns/${campaignId}`
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Campaign deleted`, 'success');
        selectedCampaignId = null;
        selectedAdGroupId = null;
        document.getElementById('adgroups-list').innerHTML = '';
        document.getElementById('ads-list').innerHTML = '';
        await loadCampaigns(selectedCustomerId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function deleteAdGroup(adGroupId, adGroupName) {
      if (!confirm(`Are you sure you want to delete ad group "${adGroupName}"?\n\nThis will also delete all ads within this ad group.`)) {
        return;
      }
      try {
        showStatus('data-status', `Deleting ad group...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroups/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              remove: `customers/${selectedCustomerId}/adGroups/${adGroupId}`
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Ad group deleted`, 'success');
        selectedAdGroupId = null;
        document.getElementById('ads-list').innerHTML = '';
        await loadAdGroups(selectedCampaignId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function deleteAd(adId, adGroupId) {
      if (!confirm(`Are you sure you want to delete this ad?`)) {
        return;
      }
      try {
        showStatus('data-status', `Deleting ad...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupAds/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              remove: `customers/${selectedCustomerId}/adGroupAds/${adGroupId}~${adId}`
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Ad deleted`, 'success');
        await loadAds(selectedAdGroupId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>

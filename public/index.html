<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Ads Integration Test</title>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #4285f4; }
    h2 { margin-top: 0; }
    h3 { margin: 10px 0; }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label { display: block; margin-bottom: 5px; font-weight: 600; }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover { background: #3367d6; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.secondary { background: #666; }
    button.secondary:hover { background: #444; }
    button.toggle-enable { background: #28a745; }
    button.toggle-enable:hover { background: #218838; }
    button.toggle-pause { background: #ffc107; color: #212529; }
    button.toggle-pause:hover { background: #e0a800; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    .item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 8px;
      border-left: 4px solid #4285f4;
      cursor: pointer;
    }
    .item:hover { background: #e9ecef; }
    .item.selected { background: #d4edda; border-left-color: #28a745; }
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item-details { font-size: 12px; color: #666; margin-top: 5px; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge.enabled { background: #d4edda; color: #155724; }
    .badge.paused { background: #fff3cd; color: #856404; }
    .badge.removed { background: #f8d7da; color: #721c24; }
    .list-container { margin-top: 10px; max-height: 300px; overflow-y: auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
      max-height: 250px;
      overflow-y: auto;
    }
    
    /* Keyword Management Styles */
    .keyword-item { display: flex; align-items: center; gap: 8px; padding: 8px; border-bottom: 1px solid #eee; }
    .keyword-text { flex: 1; font-weight: 500; }
    .match-type { padding: 2px 6px; border-radius: 3px; font-size: 11px; }
    .match-type.BROAD { background: #e3f2fd; color: #1565c0; }
    .match-type.PHRASE { background: #fff3e0; color: #e65100; }
    .match-type.EXACT { background: #e8f5e9; color: #2e7d32; }
    select.match-select { padding: 4px; font-size: 12px; border-radius: 4px; }
    
    /* Detail Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .modal-overlay.visible {
      opacity: 1;
    }
    .modal-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 700px;
      width: 90%;
      max-height: 85vh;
      overflow: hidden;
      z-index: 1001;
      transition: transform 0.25s ease;
    }
    .modal-overlay.visible .modal-container {
      transform: translate(-50%, -50%) scale(1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e9ecef;
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
    }
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      max-width: calc(100% - 40px);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .modal-header .modal-type {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.85;
      margin-bottom: 4px;
    }
    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .modal-close:hover {
      background: rgba(255,255,255,0.35);
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(85vh - 80px);
    }
    .modal-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #666;
    }
    .modal-loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e9ecef;
      border-top-color: #4285f4;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .detail-section {
      margin-bottom: 24px;
    }
    .detail-section:last-child {
      margin-bottom: 0;
    }
    .detail-section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #4285f4;
      font-weight: 700;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e9ecef;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f1f3f5;
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-label {
      font-weight: 500;
      color: #495057;
      font-size: 13px;
    }
    .detail-value {
      color: #212529;
      font-size: 13px;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }
    .detail-value.mono {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .detail-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .detail-list li {
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
      border-left: 3px solid #4285f4;
    }
    .detail-list li:last-child {
      margin-bottom: 0;
    }
    .modal-error {
      text-align: center;
      padding: 40px 20px;
      color: #dc3545;
    }
    .modal-error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* Form Section Styles */
    .form-section { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e0e0e0; }
    .form-section:last-child { border-bottom: none; }
    .section-title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .section-title .badge { font-size: 10px; padding: 2px 6px; border-radius: 3px; }
    .section-title .badge.required { background: #dc3545; color: white; }
    .section-title .badge.optional { background: #6c757d; color: white; }
    .char-counter { font-size: 11px; color: #666; text-align: right; margin-top: 2px; }
    .char-counter.warning { color: #e65100; }
    .char-counter.error { color: #dc3545; }
    .dynamic-fields { display: flex; flex-direction: column; gap: 8px; }
    .dynamic-field { display: flex; gap: 8px; align-items: center; }
    .dynamic-field input { flex: 1; }
    .dynamic-field button { padding: 4px 8px; font-size: 12px; }
    .add-field-btn { background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px; }
    .add-field-btn:hover { background: #218838; }
    .add-field-btn:disabled { background: #ccc; cursor: not-allowed; }
    .remove-field-btn { background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    .url-preview { font-size: 12px; color: #666; margin-top: 4px; font-family: monospace; }
    .path-inputs { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .path-inputs span { color: #666; }
    .path-inputs input { width: 120px; }
    .divider { text-align: center; padding: 16px 0; color: #666; font-size: 13px; font-weight: 500; border-top: 2px dashed #ccc; margin-top: 16px; }
  </style>
</head>
<body>
  <!-- Detail Modal -->
  <div class="modal-overlay" id="detail-modal" onclick="closeModalOnOverlay(event)">
    <div class="modal-container">
      <div class="modal-header">
        <div>
          <div class="modal-type" id="modal-type">Campaign</div>
          <h3 id="modal-title">Loading...</h3>
        </div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <div class="modal-loading">
          <div class="spinner"></div>
          <span>Loading details...</span>
        </div>
      </div>
    </div>
  </div>

  <h1>Google Ads Integration</h1>
  
  <div class="card">
    <h2>Step 1: Set User ID</h2>
    <label for="userId">External User ID:</label>
    <input type="text" id="userId" placeholder="e.g., user-123" value="test-user-1">
    <button onclick="saveUserId()">Save User ID</button>
    <div id="userId-status"></div>
  </div>

  <div class="card">
    <h2>Step 2: Connect Google Ads Account</h2>
    <button onclick="connectGoogleAds()">Connect Google Ads</button>
    <button class="secondary" onclick="refreshAccounts()">Refresh</button>
    <div id="connect-status"></div>
    <div id="accounts-list" class="list-container"></div>
  </div>

  <div class="card">
    <h2>Step 3: Browse Data (via Proxy)</h2>
    <button onclick="loadCustomers()" id="load-btn" disabled>Load Accessible Customers</button>
    <div id="data-status"></div>
    
    <div class="grid">
      <div>
        <h3>Customers</h3>
        <div id="customers-list" class="list-container"></div>
      </div>
      <div>
        <h3>Campaigns</h3>
        <div id="campaigns-list" class="list-container"></div>
      </div>
    </div>
    
    <div class="grid">
      <div>
        <h3>Ad Groups</h3>
        <div id="adgroups-list" class="list-container"></div>
      </div>
      <div>
        <h3>Ads</h3>
        <div id="ads-list" class="list-container"></div>
      </div>
    </div>
    
    <!-- Keywords Section -->
    <div class="card" style="margin-top: 20px;">
      <h3>Keywords</h3>
      <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Keywords belong to the Ad Group and are shared by all Ads</p>
      <div id="adgroup-keywords-list"></div>
      <div id="keywords-status" class="status"></div>
    </div>
  </div>

  <div class="card">
    <h2>Step 4: Generate Keyword Ideas</h2>
    <div class="grid">
      <div>
        <label for="keyword-input">Keywords (comma separated):</label>
        <input type="text" id="keyword-input" placeholder="e.g., digital marketing, seo">
      </div>
      <div>
        <label for="url-input">URL (optional):</label>
        <input type="text" id="url-input" placeholder="e.g., https://example.com">
      </div>
    </div>
    <div class="grid">
      <div>
        <label for="language-select">Language:</label>
        <select id="language-select">
          <option value="languageConstants/1000">English</option>
          <option value="languageConstants/1027">Hebrew</option>
          <option value="languageConstants/1004">Spanish</option>
          <option value="languageConstants/1001">German</option>
          <option value="languageConstants/1002">French</option>
        </select>
      </div>
      <div>
        <label for="geo-select">Location:</label>
        <select id="geo-select">
          <option value="geoTargetConstants/2376">Israel</option>
          <option value="geoTargetConstants/2840">United States</option>
          <option value="geoTargetConstants/2826">United Kingdom</option>
          <option value="geoTargetConstants/2276">Germany</option>
          <option value="geoTargetConstants/2250">France</option>
        </select>
      </div>
    </div>
    <button onclick="generateKeywordIdeas()" id="keyword-btn" disabled>Generate Keyword Ideas</button>
    <div id="keyword-status"></div>
    <div id="keywords-list" class="list-container" style="max-height: 400px;"></div>
  </div>

  <!-- Step 5: Create Complete Campaign (Enhanced) -->
  <div class="card">
    <h3>Step 5: Create Complete Campaign</h3>
    
    <!-- SECTION: Campaign & Budget -->
    <div class="form-section">
      <div class="section-title">
        CAMPAIGN & BUDGET
        <span class="badge required">REQUIRED</span>
      </div>
      <div class="grid">
        <div>
          <label>Campaign Name</label>
          <input type="text" id="adv-campaign-name" placeholder="My Campaign" value="Test Campaign - Digital Marketing">
        </div>
        <div>
          <label>Daily Budget (USD)</label>
          <input type="number" id="adv-budget" value="0.10" step="0.01" min="0.01">
        </div>
        <div>
          <label>Status</label>
          <select id="adv-status">
            <option value="PAUSED" selected>PAUSED</option>
            <option value="ENABLED">ENABLED</option>
          </select>
        </div>
      </div>
    </div>

    <!-- SECTION: Ad Group & Keywords -->
    <div class="form-section">
      <div class="section-title">
        AD GROUP & KEYWORDS
        <span class="badge required">REQUIRED</span>
      </div>
      <div>
        <label>Ad Group Name</label>
        <input type="text" id="adv-adgroup-name" placeholder="My Ad Group" value="Digital Marketing Services">
      </div>
      <div style="margin-top: 12px;">
        <label>Keywords (comma-separated)</label>
        <textarea id="adv-keywords" rows="2" placeholder="keyword 1, keyword 2, keyword 3">digital marketing, online advertising, seo services, social media marketing, ppc management</textarea>
      </div>
      <div style="margin-top: 12px;">
        <label>Max CPC (USD)</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 16px;">$</span>
          <input type="number" id="adv-max-cpc" step="0.01" min="0.01" placeholder="1.00" value="1.00" style="width: 120px;">
        </div>
        <p style="font-size:11px; color:#666; margin-top:4px;">Maximum cost-per-click bid. Will be converted to your account's currency.</p>
      </div>
    </div>

    <!-- SECTION: Headlines & Descriptions -->
    <div class="form-section">
      <div class="section-title">
        HEADLINES & DESCRIPTIONS
        <span class="badge required">REQUIRED</span>
      </div>
      
      <label>Headlines (min 2, max 15)</label>
      <div id="headlines-container" class="dynamic-fields">
        <div class="dynamic-field">
          <input type="text" class="headline-input" maxlength="30" placeholder="Headline 1" value="Expert Digital Marketing" oninput="updateCharCounter(this, 30)">
          <span class="char-counter">24/30</span>
        </div>
        <div class="dynamic-field">
          <input type="text" class="headline-input" maxlength="30" placeholder="Headline 2" value="Grow Your Business Online" oninput="updateCharCounter(this, 30)">
          <span class="char-counter">25/30</span>
        </div>
        <div class="dynamic-field">
          <input type="text" class="headline-input" maxlength="30" placeholder="Headline 3" value="Get Results Fast" oninput="updateCharCounter(this, 30)">
          <span class="char-counter">16/30</span>
        </div>
      </div>
      <button type="button" class="add-field-btn" onclick="addHeadline()">+ Add Headline</button>
      
      <div style="margin-top: 16px;">
        <label>Descriptions (min 2, max 4)</label>
        <div id="descriptions-container" class="dynamic-fields">
          <div class="dynamic-field">
            <input type="text" class="description-input" maxlength="90" placeholder="Description 1" value="Professional digital marketing services to help your business reach more customers online." oninput="updateCharCounter(this, 90)">
            <span class="char-counter">89/90</span>
          </div>
          <div class="dynamic-field">
            <input type="text" class="description-input" maxlength="90" placeholder="Description 2" value="SEO, PPC, and social media marketing. Get a free consultation today. Call now!" oninput="updateCharCounter(this, 90)">
            <span class="char-counter">79/90</span>
          </div>
        </div>
        <button type="button" class="add-field-btn" onclick="addDescription()">+ Add Description</button>
      </div>
    </div>

    <!-- SECTION: Final URL -->
    <div class="form-section">
      <div class="section-title">
        FINAL URL
        <span class="badge required">REQUIRED</span>
      </div>
      <div>
        <label>Final URL</label>
        <input type="url" id="adv-final-url" placeholder="https://example.com/products/shoes" value="https://example.com/digital-marketing/services">
        <p style="font-size:11px; color:#666; margin-top:4px;">Display paths will be auto-extracted from URL (max 2 path segments, 15 chars each)</p>
      </div>
      <input type="hidden" id="adv-path1">
      <input type="hidden" id="adv-path2">
    </div>

    <!-- DIVIDER: Optional Extensions -->
    <div class="divider">
      ────────── OPTIONAL EXTENSIONS ──────────
    </div>

    <!-- Placeholder for optional sections (will be added by Agent 3) -->
    <div id="optional-extensions-container">
      <!-- SECTION: Promotions -->
      <div class="form-section">
        <div class="section-title">
          PROMOTIONS
          <span class="badge optional">OPTIONAL</span>
        </div>
        <div class="grid">
          <div>
            <label>Occasion</label>
            <select id="promo-occasion">
              <option value="">None</option>
              <option value="NEW_YEARS" selected>New Year's</option>
              <option value="VALENTINES_DAY">Valentine's Day</option>
              <option value="EASTER">Easter</option>
              <option value="MOTHERS_DAY">Mother's Day</option>
              <option value="FATHERS_DAY">Father's Day</option>
              <option value="LABOR_DAY">Labor Day</option>
              <option value="BACK_TO_SCHOOL">Back to School</option>
              <option value="HALLOWEEN">Halloween</option>
              <option value="BLACK_FRIDAY">Black Friday</option>
              <option value="CYBER_MONDAY">Cyber Monday</option>
              <option value="CHRISTMAS">Christmas</option>
              <option value="SUMMER_SALE">Summer Sale</option>
              <option value="WINTER_SALE">Winter Sale</option>
              <option value="END_OF_SEASON">End of Season</option>
            </select>
            <p style="font-size:10px; color:#666; margin-top:4px;">Choose an occasion or select dates below</p>
          </div>
        </div>
        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Language</label>
            <select id="promo-language">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="it">Italian</option>
              <option value="pt">Portuguese</option>
              <option value="he">Hebrew</option>
              <option value="ar">Arabic</option>
              <option value="zh">Chinese</option>
              <option value="ja">Japanese</option>
            </select>
          </div>
          <div>
            <label>Currency</label>
            <select id="promo-currency">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="ILS">ILS</option>
            </select>
          </div>
        </div>
        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Promotion Type</label>
            <select id="promo-discount-type" onchange="togglePromoDiscount()">
              <option value="">-- Select --</option>
              <option value="money">Monetary Discount</option>
              <option value="percent" selected>Percent Discount</option>
            </select>
          </div>
          <div id="promo-money-fields" style="display:none;">
            <label>Amount ($)</label>
            <input type="number" id="promo-money-amount" step="0.01" min="0" placeholder="10.00">
          </div>
          <div id="promo-percent-fields" style="display:block;">
            <label>Percent Off (%)</label>
            <input type="number" id="promo-percent" min="1" max="100" placeholder="20" value="20">
          </div>
        </div>
        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Item (what's being promoted)</label>
            <input type="text" id="promo-target" maxlength="20" placeholder="Summer Sale" value="All Services" oninput="updateCharCounter(this, 20)">
            <div class="char-counter">12/20</div>
          </div>
        </div>
        <div style="margin-top:12px;">
          <label>Final URL</label>
          <input type="url" id="promo-final-url" placeholder="https://example.com/promo" value="https://example.com/new-year-sale">
        </div>
        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Promotion Details</label>
            <select id="promo-details-type" onchange="togglePromoDetails()">
              <option value="">None</option>
              <option value="code" selected>On orders with promo code</option>
              <option value="minimum">On orders over</option>
            </select>
          </div>
          <div id="promo-code-field" style="display:block;">
            <label>Promo Code</label>
            <input type="text" id="promo-code" placeholder="SAVE20" value="NEWYEAR20">
          </div>
          <div id="promo-min-order-field" style="display:none;">
            <label>Minimum Order Amount</label>
            <input type="number" id="promo-min-order" step="0.01" min="0" placeholder="50.00">
          </div>
        </div>
        <div style="margin-top:12px;">
          <label>Displayed Promotion Dates</label>
          <p style="font-size:10px; color:#666; margin-bottom:8px;">Show the dates of your promotion</p>
          <div class="grid">
            <div>
              <label style="font-size:12px;">Start Date</label>
              <input type="date" id="promo-start-date">
            </div>
            <div>
              <label style="font-size:12px;">End Date</label>
              <input type="date" id="promo-end-date">
            </div>
          </div>
        </div>
      </div>

      <!-- SECTION: Prices -->
      <div class="form-section">
        <div class="section-title">
          PRICES
          <span class="badge optional">OPTIONAL</span>
        </div>
        <p style="font-size:11px; color:#666; margin-bottom:8px;">Note: Google requires 3-8 price offerings if used</p>
        <div class="grid">
          <div>
            <label>Price Type</label>
            <select id="price-type">
              <option value="">-- Select --</option>
              <option value="BRANDS">Brands</option>
              <option value="EVENTS">Events</option>
              <option value="LOCATIONS">Locations</option>
              <option value="NEIGHBORHOODS">Neighborhoods</option>
              <option value="PRODUCT_CATEGORIES">Product Categories</option>
              <option value="PRODUCT_TIERS">Product Tiers</option>
              <option value="SERVICES" selected>Services</option>
              <option value="SERVICE_CATEGORIES">Service Categories</option>
              <option value="SERVICE_TIERS">Service Tiers</option>
            </select>
          </div>
          <div>
            <label>Qualifier</label>
            <select id="price-qualifier">
              <option value="">None</option>
              <option value="FROM" selected>From</option>
              <option value="UP_TO">Up To</option>
              <option value="AVERAGE">Average</option>
            </select>
          </div>
          <div>
            <label>Language</label>
            <input type="text" id="price-language" value="en" maxlength="5">
          </div>
        </div>
        <div id="price-offerings-container" style="margin-top:12px;">
          <!-- Offering 1: Basic -->
          <div class="price-offering" style="border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px;">
            <div class="grid">
              <div>
                <label>Header</label>
                <input type="text" class="price-header" maxlength="25" placeholder="Basic Plan" value="Basic SEO" oninput="updateCharCounter(this, 25)">
                <div class="char-counter">9/25</div>
              </div>
              <div>
                <label>Description</label>
                <input type="text" class="price-description" maxlength="25" placeholder="Great for starters" value="Small business package" oninput="updateCharCounter(this, 25)">
                <div class="char-counter">22/25</div>
              </div>
            </div>
            <div class="grid" style="margin-top:8px;">
              <div>
                <label>Price</label>
                <input type="number" class="price-amount" step="0.01" min="0" placeholder="9.99" value="299">
              </div>
              <div>
                <label>Currency</label>
                <select class="price-currency">
                  <option value="USD" selected>USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="ILS">ILS</option>
                </select>
              </div>
              <div>
                <label>Unit</label>
                <select class="price-unit">
                  <option value="">None</option>
                  <option value="PER_HOUR">Per Hour</option>
                  <option value="PER_DAY">Per Day</option>
                  <option value="PER_WEEK">Per Week</option>
                  <option value="PER_MONTH" selected>Per Month</option>
                  <option value="PER_YEAR">Per Year</option>
                  <option value="PER_NIGHT">Per Night</option>
                </select>
              </div>
            </div>
            <div style="margin-top:8px;">
              <label>Offering URL</label>
              <input type="url" class="price-url" placeholder="https://example.com/pricing" value="https://example.com/pricing/basic">
            </div>
          </div>
          <!-- Offering 2: Professional -->
          <div class="price-offering" style="border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px;">
            <div class="grid">
              <div>
                <label>Header</label>
                <input type="text" class="price-header" maxlength="25" placeholder="Basic Plan" value="Professional" oninput="updateCharCounter(this, 25)">
                <div class="char-counter">12/25</div>
              </div>
              <div>
                <label>Description</label>
                <input type="text" class="price-description" maxlength="25" placeholder="Great for starters" value="Growing businesses" oninput="updateCharCounter(this, 25)">
                <div class="char-counter">18/25</div>
              </div>
            </div>
            <div class="grid" style="margin-top:8px;">
              <div>
                <label>Price</label>
                <input type="number" class="price-amount" step="0.01" min="0" placeholder="9.99" value="599">
              </div>
              <div>
                <label>Currency</label>
                <select class="price-currency">
                  <option value="USD" selected>USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="ILS">ILS</option>
                </select>
              </div>
              <div>
                <label>Unit</label>
                <select class="price-unit">
                  <option value="">None</option>
                  <option value="PER_HOUR">Per Hour</option>
                  <option value="PER_DAY">Per Day</option>
                  <option value="PER_WEEK">Per Week</option>
                  <option value="PER_MONTH" selected>Per Month</option>
                  <option value="PER_YEAR">Per Year</option>
                  <option value="PER_NIGHT">Per Night</option>
                </select>
              </div>
            </div>
            <div style="margin-top:8px;">
              <label>Offering URL</label>
              <input type="url" class="price-url" placeholder="https://example.com/pricing" value="https://example.com/pricing/pro">
            </div>
          </div>
          <!-- Offering 3: Enterprise -->
          <div class="price-offering" style="border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px;">
            <div class="grid">
              <div>
                <label>Header</label>
                <input type="text" class="price-header" maxlength="25" placeholder="Basic Plan" value="Enterprise" oninput="updateCharCounter(this, 25)">
                <div class="char-counter">10/25</div>
              </div>
              <div>
                <label>Description</label>
                <input type="text" class="price-description" maxlength="25" placeholder="Great for starters" value="Full-service solution" oninput="updateCharCounter(this, 25)">
                <div class="char-counter">21/25</div>
              </div>
            </div>
            <div class="grid" style="margin-top:8px;">
              <div>
                <label>Price</label>
                <input type="number" class="price-amount" step="0.01" min="0" placeholder="9.99" value="1299">
              </div>
              <div>
                <label>Currency</label>
                <select class="price-currency">
                  <option value="USD" selected>USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="ILS">ILS</option>
                </select>
              </div>
              <div>
                <label>Unit</label>
                <select class="price-unit">
                  <option value="">None</option>
                  <option value="PER_HOUR">Per Hour</option>
                  <option value="PER_DAY">Per Day</option>
                  <option value="PER_WEEK">Per Week</option>
                  <option value="PER_MONTH" selected>Per Month</option>
                  <option value="PER_YEAR">Per Year</option>
                  <option value="PER_NIGHT">Per Night</option>
                </select>
              </div>
            </div>
            <div style="margin-top:8px;">
              <label>Offering URL</label>
              <input type="url" class="price-url" placeholder="https://example.com/pricing" value="https://example.com/pricing/enterprise">
            </div>
          </div>
        </div>
        <button type="button" class="add-field-btn" onclick="addPriceOffering()">+ Add Price Offering</button>
      </div>

      <!-- SECTION: Calls -->
      <div class="form-section">
        <div class="section-title">
          CALLS
          <span class="badge optional">OPTIONAL</span>
        </div>
        <div class="grid">
          <div>
            <label>Country Code</label>
            <input type="text" id="call-country" value="IL" maxlength="2" style="width:60px;">
          </div>
          <div>
            <label>Phone Number</label>
            <input type="tel" id="call-phone" placeholder="0522598777" value="0522598777">
          </div>
        </div>
      </div>

      <!-- SECTION: Callouts -->
      <div class="form-section">
        <div class="section-title">
          CALLOUTS
          <span class="badge optional">OPTIONAL</span>
        </div>
        <div id="callouts-container" class="dynamic-fields">
          <div class="callout-item" style="border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px;">
            <div class="dynamic-field">
              <input type="text" class="callout-input" maxlength="25" placeholder="Free Shipping" value="Free Consultation" oninput="updateCharCounter(this, 25)">
              <span class="char-counter">17/25</span>
            </div>
            <div class="grid" style="margin-top:8px;">
              <div>
                <label style="font-size:12px;">Start Date (optional)</label>
                <input type="date" class="callout-start-date">
              </div>
              <div>
                <label style="font-size:12px;">End Date (optional)</label>
                <input type="date" class="callout-end-date">
              </div>
            </div>
          </div>
          <div class="callout-item" style="border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px;">
            <div class="dynamic-field">
              <input type="text" class="callout-input" maxlength="25" placeholder="Free Shipping" value="24/7 Support" oninput="updateCharCounter(this, 25)">
              <span class="char-counter">11/25</span>
            </div>
            <div class="grid" style="margin-top:8px;">
              <div>
                <label style="font-size:12px;">Start Date (optional)</label>
                <input type="date" class="callout-start-date">
              </div>
              <div>
                <label style="font-size:12px;">End Date (optional)</label>
                <input type="date" class="callout-end-date">
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="add-field-btn" onclick="addCallout()">+ Add Callout</button>
      </div>

      <!-- SECTION: Sitelinks -->
      <div class="form-section">
        <div class="section-title">
          SITELINKS
          <span class="badge optional">OPTIONAL</span>
        </div>
        <div id="sitelinks-container" class="dynamic-fields">
          <div class="sitelink-item" style="border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px;">
            <div class="grid">
              <div>
                <label>Link Text</label>
                <input type="text" class="sitelink-text" maxlength="25" placeholder="About Us" value="About Us" oninput="updateCharCounter(this, 25)">
                <span class="char-counter">8/25</span>
              </div>
              <div>
                <label>Final URL</label>
                <input type="url" class="sitelink-url" placeholder="https://example.com/about" value="https://example.com/about">
              </div>
            </div>
            <div class="grid" style="margin-top:8px;">
              <div>
                <label>Description Line 1 (optional)</label>
                <input type="text" class="sitelink-desc1" maxlength="35" placeholder="Learn more about us" value="Learn more about our company" oninput="updateCharCounter(this, 35)">
                <span class="char-counter">28/35</span>
              </div>
              <div>
                <label>Description Line 2 (optional)</label>
                <input type="text" class="sitelink-desc2" maxlength="35" placeholder="Our story and mission" value="Our story and values" oninput="updateCharCounter(this, 35)">
                <span class="char-counter">20/35</span>
              </div>
            </div>
          </div>
          <div class="sitelink-item" style="border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px;">
            <div class="grid">
              <div>
                <label>Link Text</label>
                <input type="text" class="sitelink-text" maxlength="25" placeholder="Contact" value="Contact Us" oninput="updateCharCounter(this, 25)">
                <span class="char-counter">10/25</span>
              </div>
              <div>
                <label>Final URL</label>
                <input type="url" class="sitelink-url" placeholder="https://example.com/contact" value="https://example.com/contact">
              </div>
            </div>
            <div class="grid" style="margin-top:8px;">
              <div>
                <label>Description Line 1 (optional)</label>
                <input type="text" class="sitelink-desc1" maxlength="35" placeholder="Get in touch with us" value="Get in touch with our team" oninput="updateCharCounter(this, 35)">
                <span class="char-counter">26/35</span>
              </div>
              <div>
                <label>Description Line 2 (optional)</label>
                <input type="text" class="sitelink-desc2" maxlength="35" placeholder="We're here to help" value="We respond within 24 hours" oninput="updateCharCounter(this, 35)">
                <span class="char-counter">26/35</span>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="add-field-btn" onclick="addSitelink()">+ Add Sitelink</button>
      </div>

      <!-- SECTION: Lead Form -->
      <div class="form-section">
        <div class="section-title">
          LEAD FORM
          <span class="badge optional">OPTIONAL</span>
        </div>
        <div id="lead-form-tos-status" style="margin-bottom:12px; padding:8px 12px; border-radius:4px; font-size:13px; display:flex; align-items:center; justify-content:space-between;">
          <span id="lead-form-tos-text" style="color:#666;">Click to check Terms of Service status</span>
          <button type="button" onclick="checkLeadFormToS()" style="padding:4px 10px; font-size:12px; cursor:pointer;">Check Status</button>
        </div>
        <div class="grid">
          <div>
            <label>Business Name</label>
            <input type="text" id="lead-business" maxlength="25" placeholder="Acme Corp" value="Digital Marketing Pro" oninput="updateCharCounter(this, 25)">
            <div class="char-counter">20/25</div>
          </div>
          <div>
            <label>Headline</label>
            <input type="text" id="lead-headline" maxlength="30" placeholder="Get a Free Quote" value="Get Your Free Marketing Audit" oninput="updateCharCounter(this, 30)">
            <div class="char-counter">29/30</div>
          </div>
        </div>
        <div style="margin-top:8px;">
          <label>Description</label>
          <textarea id="lead-description" maxlength="200" rows="2" placeholder="Fill out the form to get started..." oninput="updateCharCounter(this, 200)">Fill out this quick form and one of our experts will contact you within 24 hours to discuss your digital marketing needs.</textarea>
          <div class="char-counter">120/200</div>
        </div>
        <div class="grid" style="margin-top:8px;">
          <div>
            <label>Privacy Policy URL</label>
            <input type="url" id="lead-privacy-url" placeholder="https://example.com/privacy" value="https://example.com/privacy">
          </div>
          <div>
            <label>CTA Type</label>
            <select id="lead-cta-type">
              <option value="LEARN_MORE">Learn More</option>
              <option value="GET_QUOTE" selected>Get Quote</option>
              <option value="APPLY_NOW">Apply Now</option>
              <option value="SIGN_UP">Sign Up</option>
              <option value="CONTACT_US">Contact Us</option>
              <option value="SUBSCRIBE">Subscribe</option>
              <option value="DOWNLOAD">Download</option>
              <option value="BOOK_NOW">Book Now</option>
              <option value="GET_OFFER">Get Offer</option>
              <option value="REGISTER">Register</option>
              <option value="GET_INFO">Get Info</option>
              <option value="REQUEST_DEMO">Request Demo</option>
              <option value="JOIN_NOW">Join Now</option>
              <option value="GET_STARTED">Get Started</option>
            </select>
          </div>
        </div>
        <div style="margin-top:8px;">
          <label>CTA Description</label>
          <input type="text" id="lead-cta-desc" maxlength="30" placeholder="Request your free quote today" value="Get your free audit now" oninput="updateCharCounter(this, 30)">
          <div class="char-counter">23/30</div>
        </div>
        <div class="grid" style="margin-top:8px;">
          <div>
            <label>Post-Submit Headline</label>
            <input type="text" id="lead-post-headline" maxlength="30" placeholder="Thank you!" value="Thank You!" oninput="updateCharCounter(this, 30)">
            <div class="char-counter">10/30</div>
          </div>
          <div>
            <label>Post-Submit Description</label>
            <input type="text" id="lead-post-desc" maxlength="200" placeholder="We'll be in touch soon" value="Our team will contact you within 24 hours" oninput="updateCharCounter(this, 200)">
            <div class="char-counter">41/200</div>
          </div>
        </div>
        <div style="margin-top:12px;">
          <label>Fields to Collect:</label>
          <p style="font-size:11px; color:#666; margin:4px 0 8px;">Contact Information</p>
          <div style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px;">
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="FULL_NAME" checked> Name</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="EMAIL" checked> Email</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="PHONE_NUMBER" checked> Phone Number</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="COUNTRY"> Country</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="CITY"> City</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="POSTAL_CODE"> Zip/Postal Code</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="REGION"> State/Province</label>
          </div>
          <p style="font-size:11px; color:#666; margin:4px 0 8px;">Work Information</p>
          <div style="display:flex; flex-wrap:wrap; gap:12px;">
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="COMPANY_NAME"> Company Name</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="WORK_EMAIL"> Work Email</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="WORK_PHONE"> Work Phone</label>
            <label style="font-weight:normal;"><input type="checkbox" class="lead-field" value="JOB_TITLE"> Job Title</label>
          </div>
        </div>
      </div>

      <!-- SECTION: Mobile App -->
      <div class="form-section">
        <div class="section-title">
          MOBILE APP
          <span class="badge optional">OPTIONAL</span>
        </div>
        <div class="grid">
          <div>
            <label>App Store</label>
            <select id="app-store">
              <option value="">-- Select --</option>
              <option value="APPLE_APP_STORE">Apple App Store</option>
              <option value="GOOGLE_APP_STORE" selected>Google Play Store</option>
            </select>
          </div>
          <div>
            <label>App ID</label>
            <input type="text" id="app-id" placeholder="com.example.app" value="com.google.android.apps.maps">
          </div>
          <div>
            <label>Link Text</label>
            <input type="text" id="app-link-text" maxlength="25" placeholder="Download Now" value="Get the App" oninput="updateCharCounter(this, 25)">
            <div class="char-counter">11/25</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div style="margin-top: 24px;">
      <button id="adv-create-campaign-btn" onclick="createAdvancedCampaign()" disabled>Create Complete Campaign</button>
      <div id="adv-create-campaign-status" class="status"></div>
    </div>
  </div>

  <div class="card">
    <h2>Raw API Response</h2>
    <pre id="raw-response">Click "Load Accessible Customers" to start...</pre>
  </div>

  <script>
    let currentUserId = 'test-user-1';
    let selectedAccountId = null;
    let selectedCustomerId = null;
    let selectedCampaignId = null;
    let selectedAdGroupId = null;

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `status ${type}`;
      el.innerHTML = message;
    }

    function formatStatus(status) {
      const s = (status || '').toString().toUpperCase();
      if (s.includes('ENABLED')) return '<span class="badge enabled">ENABLED</span>';
      if (s.includes('PAUSED')) return '<span class="badge paused">PAUSED</span>';
      if (s.includes('REMOVED')) return '<span class="badge removed">REMOVED</span>';
      return `<span class="badge">${s || 'UNKNOWN'}</span>`;
    }

    function formatMicros(micros) {
      if (!micros) return 'N/A';
      return '$' + (parseInt(micros) / 1000000).toFixed(2);
    }

    function showRawResponse(data) {
      document.getElementById('raw-response').textContent = JSON.stringify(data, null, 2);
    }

    function saveUserId() {
      currentUserId = document.getElementById('userId').value.trim();
      if (!currentUserId) {
        showStatus('userId-status', 'Please enter a user ID', 'error');
        return;
      }
      showStatus('userId-status', `User ID set to: ${currentUserId}`, 'success');
      selectedAccountId = null;
      selectedCustomerId = null;
      clearAllLists();
      refreshAccounts();
    }

    function clearAllLists() {
      ['accounts-list', 'customers-list', 'campaigns-list', 'adgroups-list', 'ads-list', 'adgroup-keywords-list'].forEach(id => {
        document.getElementById(id).innerHTML = '';
      });
    }

    async function connectGoogleAds() {
      if (!currentUserId) {
        showStatus('connect-status', 'Please set a user ID first', 'error');
        return;
      }

      try {
        showStatus('connect-status', 'Getting connect token...', 'info');
        
        const tokenResponse = await fetch('/api/connect-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ externalUserId: currentUserId }),
        });
        
        if (!tokenResponse.ok) throw new Error((await tokenResponse.json()).error || 'Failed to get token');
        
        const { connectLinkUrl } = await tokenResponse.json();
        showStatus('connect-status', 'Opening Google Ads connection popup...', 'info');
        
        const popup = window.open(connectLinkUrl, 'google-ads-connect', 
          `width=600,height=700,left=${(window.innerWidth-600)/2},top=${(window.innerHeight-700)/2}`);
        
        window.addEventListener('message', function handler(event) {
          if (event.data?.type === 'google-ads-connected') {
            window.removeEventListener('message', handler);
            showStatus('connect-status', 'Google Ads connected!', 'success');
            selectedAccountId = event.data.accountId || null;
            refreshAccounts();
          }
        });
        
        const checkPopup = setInterval(() => {
          if (popup.closed) {
            clearInterval(checkPopup);
            setTimeout(refreshAccounts, 1000);
          }
        }, 500);
      } catch (error) {
        showStatus('connect-status', `Error: ${error.message}`, 'error');
      }
    }

    async function refreshAccounts() {
      if (!currentUserId) return;

      try {
        const response = await fetch(`/api/accounts?externalUserId=${encodeURIComponent(currentUserId)}`);
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        const accounts = data.data || [];
        const listEl = document.getElementById('accounts-list');
        
        if (accounts.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No Google Ads accounts connected.</p>';
          document.getElementById('load-btn').disabled = true;
          return;
        }
        
        listEl.innerHTML = accounts.map(acc => `
          <div class="item ${selectedAccountId === acc.id ? 'selected' : ''}" onclick="selectAccount('${acc.id}')">
            <div class="item-header">
              <strong>${acc.name || 'Google Ads Account'}</strong>
              ${selectedAccountId === acc.id ? '<span class="badge enabled">Selected</span>' : ''}
            </div>
            <div class="item-details">ID: ${acc.id}</div>
          </div>
        `).join('');
        
        if (!selectedAccountId && accounts.length > 0) selectAccount(accounts[0].id);
      } catch (error) {
        showStatus('connect-status', `Error: ${error.message}`, 'error');
      }
    }

    function selectAccount(accountId) {
      selectedAccountId = accountId;
      selectedCustomerId = null;
      clearAllLists();
      refreshAccounts();
      document.getElementById('load-btn').disabled = false;
      showStatus('connect-status', `Selected account: ${accountId}`, 'success');
    }

    async function loadCustomers() {
      if (!selectedAccountId) {
        showStatus('data-status', 'Select an account first', 'error');
        return;
      }

      try {
        showStatus('data-status', 'Loading accessible customers...', 'info');
        
        const response = await fetch(
          `/api/customers?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}`
        );
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const resourceNames = data.resourceNames || [];
        const listEl = document.getElementById('customers-list');
        
        if (resourceNames.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No customers found.</p>';
          showStatus('data-status', 'No customers found', 'info');
          return;
        }
        
        listEl.innerHTML = resourceNames.map(rn => {
          const customerId = rn.replace('customers/', '');
          return `
            <div class="item ${selectedCustomerId === customerId ? 'selected' : ''}" onclick="selectCustomer('${customerId}')">
              <div class="item-header"><strong>Customer ${customerId}</strong></div>
              <div class="item-details">${rn}</div>
            </div>
          `;
        }).join('');
        
        showStatus('data-status', `Found ${resourceNames.length} customer(s). Click one to load campaigns.`, 'success');
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function loadCampaigns(customerId) {
      try {
        showStatus('data-status', 'Loading campaigns...', 'info');
        
        const response = await fetch(
          `/api/campaigns?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}&customerId=${customerId}`
        );
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const results = data.results || [];
        const listEl = document.getElementById('campaigns-list');
        
        if (results.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No campaigns found.</p>';
          showStatus('data-status', 'No campaigns found', 'info');
          return;
        }
        
        listEl.innerHTML = results.map(r => {
          const c = r.campaign || {};
          const b = r.campaignBudget || {};
          const escapedName = (c.name || 'Unnamed').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          return `
            <div class="item ${selectedCampaignId === c.id ? 'selected' : ''}" onclick="selectCampaign('${c.id}')">
              <div class="item-header">
                <strong>${c.name || 'Unnamed'}</strong>
                <span>
                  ${formatStatus(c.status)}
                  <button onclick="event.stopPropagation(); showCampaignDetails('${c.id}', '${escapedName}')" style="margin-left:8px;padding:4px 10px;font-size:11px;">Details</button>
                  <button class="${c.status === 'ENABLED' ? 'toggle-pause' : 'toggle-enable'}" onclick="event.stopPropagation(); toggleCampaignStatus('${c.id}', '${c.status}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">${c.status === 'ENABLED' ? 'Pause' : 'Enable'}</button>
                  <button class="danger" onclick="event.stopPropagation(); deleteCampaign('${c.id}', '${escapedName}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">Delete</button>
                </span>
              </div>
              <div class="item-details">
                ID: ${c.id || 'N/A'}<br>
                Type: ${c.advertisingChannelType || 'N/A'}<br>
                Budget: ${formatMicros(b.amountMicros)}/day
              </div>
            </div>
          `;
        }).join('');
        
        showStatus('data-status', `Found ${results.length} campaign(s). Click one to load ad groups.`, 'success');
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function selectCampaign(campaignId) {
      selectedCampaignId = campaignId;
      selectedAdGroupId = null;
      document.getElementById('adgroups-list').innerHTML = '';
      document.getElementById('ads-list').innerHTML = '';
      
      document.querySelectorAll('#campaigns-list .item').forEach(el => {
        el.classList.toggle('selected', el.textContent.includes(`ID: ${campaignId}`));
      });
      
      await loadAdGroups(campaignId);
    }

    async function loadAdGroups(campaignId) {
      try {
        showStatus('data-status', 'Loading ad groups...', 'info');
        
        const response = await fetch(
          `/api/ad-groups?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}&customerId=${selectedCustomerId}&campaignId=${campaignId}`
        );
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const results = data.results || [];
        const listEl = document.getElementById('adgroups-list');
        
        if (results.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No ad groups found.</p>';
          showStatus('data-status', 'No ad groups found', 'info');
          return;
        }
        
        listEl.innerHTML = results.map(r => {
          const ag = r.adGroup || {};
          const escapedName = (ag.name || 'Unnamed').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          return `
            <div class="item ${selectedAdGroupId === ag.id ? 'selected' : ''}" onclick="selectAdGroup('${ag.id}')">
              <div class="item-header">
                <strong>${ag.name || 'Unnamed'}</strong>
                <span>
                  ${formatStatus(ag.status)}
                  <button onclick="event.stopPropagation(); showAdGroupDetails('${ag.id}', '${escapedName}')" style="margin-left:8px;padding:4px 10px;font-size:11px;">Details</button>
                  <button class="${ag.status === 'ENABLED' ? 'toggle-pause' : 'toggle-enable'}" onclick="event.stopPropagation(); toggleAdGroupStatus('${ag.id}', '${ag.status}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">${ag.status === 'ENABLED' ? 'Pause' : 'Enable'}</button>
                  <button class="danger" onclick="event.stopPropagation(); deleteAdGroup('${ag.id}', '${escapedName}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">Delete</button>
                </span>
              </div>
              <div class="item-details">
                ID: ${ag.id || 'N/A'}<br>
                Type: ${ag.type || 'N/A'}<br>
                CPC: ${formatMicros(ag.cpcBidMicros)}
              </div>
            </div>
          `;
        }).join('');
        
        showStatus('data-status', `Found ${results.length} ad group(s). Click one to load ads.`, 'success');
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function selectAdGroup(adGroupId) {
      selectedAdGroupId = adGroupId;
      document.getElementById('ads-list').innerHTML = '';
      document.getElementById('adgroup-keywords-list').innerHTML = '';
      
      document.querySelectorAll('#adgroups-list .item').forEach(el => {
        el.classList.toggle('selected', el.textContent.includes(`ID: ${adGroupId}`));
      });
      
      await loadAds(adGroupId);
      await loadKeywords(adGroupId);
    }

    async function loadAds(adGroupId) {
      try {
        showStatus('data-status', 'Loading ads...', 'info');
        
        const response = await fetch(
          `/api/ads?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}&customerId=${selectedCustomerId}&adGroupId=${adGroupId}`
        );
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const results = data.results || [];
        const listEl = document.getElementById('ads-list');
        
        if (results.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No ads found.</p>';
          showStatus('data-status', 'No ads found', 'info');
          return;
        }
        
        listEl.innerHTML = results.map(r => {
          const aga = r.adGroupAd || {};
          const ad = aga.ad || {};
          const rsa = ad.responsiveSearchAd || {};
          const headlines = (rsa.headlines || []).map(h => h.text).slice(0,2).join(', ');
          return `
            <div class="item">
              <div class="item-header">
                <strong>Ad ${ad.id || 'N/A'}</strong>
                <span>
                  ${formatStatus(aga.status)}
                  <button onclick="showAdDetails('${ad.id}', '${aga.resourceName || ''}')" style="margin-left:8px;padding:4px 10px;font-size:11px;">Details</button>
                  <button class="${aga.status === 'ENABLED' ? 'toggle-pause' : 'toggle-enable'}" onclick="toggleAdStatus('${ad.id}', '${aga.status}', '${selectedAdGroupId}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">${aga.status === 'ENABLED' ? 'Pause' : 'Enable'}</button>
                  <button class="danger" onclick="deleteAd('${ad.id}', '${selectedAdGroupId}')" style="margin-left:4px;padding:4px 10px;font-size:11px;">Delete</button>
                </span>
              </div>
              <div class="item-details">
                Type: ${ad.type || 'N/A'}<br>
                Headlines: ${headlines || 'N/A'}<br>
                URLs: ${(ad.finalUrls || []).slice(0,1).join(', ') || 'N/A'}
              </div>
            </div>
          `;
        }).join('');
        
        showStatus('data-status', `Found ${results.length} ad(s)`, 'success');
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function loadKeywords(adGroupId) {
      if (!adGroupId) return;
      
      const keywordsList = document.getElementById('adgroup-keywords-list');
      keywordsList.innerHTML = '<p>Loading keywords...</p>';
      
      try {
        const response = await fetch(`/api/keywords?externalUserId=${currentUserId}&accountId=${selectedAccountId}&customerId=${selectedCustomerId}&adGroupId=${adGroupId}`);
        const data = await response.json();
        
        if (!data.results || data.results.length === 0) {
          keywordsList.innerHTML = '<p style="color:#666;">No keywords found for this ad group</p>';
          return;
        }
        
        keywordsList.innerHTML = data.results.map(r => {
          const kw = r.adGroupCriterion;
          const criterionId = kw.criterionId;
          const text = kw.keyword?.text || 'Unknown';
          const matchType = kw.keyword?.matchType || 'BROAD';
          const status = kw.status || 'ENABLED';
          const resourceName = kw.resourceName;
          const escapedText = text.replace(/'/g, "\\'");
          
          return `
            <div class="keyword-item" data-criterion-id="${criterionId}">
              <span class="keyword-text">${text}</span>
              <span class="match-type ${matchType}">${matchType}</span>
              <select class="match-select" onchange="updateKeywordMatchType('${resourceName}', this.value, '${escapedText}')">
                <option value="BROAD" ${matchType === 'BROAD' ? 'selected' : ''}>Broad</option>
                <option value="PHRASE" ${matchType === 'PHRASE' ? 'selected' : ''}>Phrase</option>
                <option value="EXACT" ${matchType === 'EXACT' ? 'selected' : ''}>Exact</option>
              </select>
              <button class="${status === 'ENABLED' ? 'toggle-pause' : 'toggle-enable'}" 
                      onclick="toggleKeywordStatus('${resourceName}', '${status}')"
                      style="padding:4px 8px;font-size:11px;">
                ${status === 'ENABLED' ? 'Pause' : 'Enable'}
              </button>
              <button class="danger" onclick="deleteKeyword('${resourceName}', '${escapedText}')" 
                      style="padding:4px 8px;font-size:11px;">
                Remove
              </button>
            </div>
          `;
        }).join('');
      } catch (error) {
        keywordsList.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    }

    async function updateKeywordMatchType(resourceName, newMatchType, keywordText) {
      try {
        showStatus('keywords-status', 'Updating match type...', 'info');
        
        await fetch(`/api/customers/${selectedCustomerId}/adGroupCriteria/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{ remove: resourceName }]
          })
        });
        
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupCriteria/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              create: {
                adGroup: `customers/${selectedCustomerId}/adGroups/${selectedAdGroupId}`,
                status: 'ENABLED',
                keyword: {
                  text: keywordText,
                  matchType: newMatchType
                }
              }
            }]
          })
        });
        
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('keywords-status', `Match type updated to ${newMatchType}`, 'success');
        await loadKeywords(selectedAdGroupId);
      } catch (error) {
        showStatus('keywords-status', `Error: ${error.message}`, 'error');
        await loadKeywords(selectedAdGroupId);
      }
    }

    async function toggleKeywordStatus(resourceName, currentStatus) {
      const newStatus = currentStatus === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      try {
        showStatus('keywords-status', 'Updating keyword status...', 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupCriteria/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              update: {
                resourceName: resourceName,
                status: newStatus
              },
              updateMask: 'status'
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('keywords-status', `Keyword ${newStatus.toLowerCase()}`, 'success');
        await loadKeywords(selectedAdGroupId);
      } catch (error) {
        showStatus('keywords-status', `Error: ${error.message}`, 'error');
      }
    }

    async function deleteKeyword(resourceName, keywordText) {
      if (!confirm(`Remove keyword "${keywordText}"?`)) return;
      
      try {
        showStatus('keywords-status', 'Removing keyword...', 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupCriteria/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{ remove: resourceName }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('keywords-status', 'Keyword removed', 'success');
        await loadKeywords(selectedAdGroupId);
      } catch (error) {
        showStatus('keywords-status', `Error: ${error.message}`, 'error');
      }
    }

    async function generateKeywordIdeas() {
      if (!selectedAccountId || !selectedCustomerId) {
        showStatus('keyword-status', 'Please select a customer first', 'error');
        return;
      }

      const keywordsInput = document.getElementById('keyword-input').value.trim();
      const urlInput = document.getElementById('url-input').value.trim();
      
      if (!keywordsInput && !urlInput) {
        showStatus('keyword-status', 'Please enter at least one keyword or URL', 'error');
        return;
      }

      const keywords = keywordsInput ? keywordsInput.split(',').map(k => k.trim()).filter(k => k) : [];
      const language = document.getElementById('language-select').value;
      const geo = document.getElementById('geo-select').value;

      try {
        showStatus('keyword-status', 'Generating keyword ideas...', 'info');
        
        const body = {
          externalUserId: currentUserId,
          accountId: selectedAccountId,
          language,
          geoTargetConstants: [geo],
        };
        
        if (keywords.length) body.keywords = keywords;
        if (urlInput) body.url = urlInput;

        const response = await fetch(`/api/customers/${selectedCustomerId}/generateKeywordIdeas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        
        if (!response.ok) throw new Error((await response.json()).error);
        
        const data = await response.json();
        showRawResponse(data);
        
        const results = data.results || [];
        const listEl = document.getElementById('keywords-list');
        
        if (results.length === 0) {
          listEl.innerHTML = '<p style="color:#666;">No keyword ideas found.</p>';
          showStatus('keyword-status', 'No keyword ideas found', 'info');
          return;
        }
        
        listEl.innerHTML = results.slice(0, 50).map(r => {
          const kw = r.keywordIdeaMetrics || {};
          const text = r.text || 'N/A';
          const competition = kw.competition || 'N/A';
          const avgSearches = kw.avgMonthlySearches || 'N/A';
          const lowBid = kw.lowTopOfPageBidMicros ? formatMicros(kw.lowTopOfPageBidMicros) : 'N/A';
          const highBid = kw.highTopOfPageBidMicros ? formatMicros(kw.highTopOfPageBidMicros) : 'N/A';
          return `
            <div class="item">
              <div class="item-header">
                <strong>${text}</strong>
                <span class="badge ${competition.toLowerCase()}">${competition}</span>
              </div>
              <div class="item-details">
                Avg Monthly Searches: ${avgSearches}<br>
                Bid Range: ${lowBid} - ${highBid}
              </div>
            </div>
          `;
        }).join('');
        
        showStatus('keyword-status', `Found ${results.length} keyword ideas (showing first 50)`, 'success');
      } catch (error) {
        showStatus('keyword-status', `Error: ${error.message}`, 'error');
      }
    }

    function selectCustomer(customerId) {
      selectedCustomerId = customerId;
      selectedCampaignId = null;
      selectedAdGroupId = null;
      document.getElementById('campaigns-list').innerHTML = '';
      document.getElementById('adgroups-list').innerHTML = '';
      document.getElementById('ads-list').innerHTML = '';
      document.getElementById('keywords-list').innerHTML = '';
      
      document.querySelectorAll('#customers-list .item').forEach(el => {
        el.classList.toggle('selected', el.textContent.includes(customerId));
      });
      
      document.getElementById('keyword-btn').disabled = false;
      document.getElementById('adv-create-campaign-btn').disabled = false;
      loadCampaigns(customerId);
    }

    document.addEventListener('DOMContentLoaded', saveUserId);
    document.addEventListener('DOMContentLoaded', checkLeadFormToS);

    async function checkLeadFormToS() {
      const statusEl = document.getElementById('lead-form-tos-status');
      const textEl = document.getElementById('lead-form-tos-text');
      const customerId = document.getElementById('customer-id').value.trim();
      const externalUserId = document.getElementById('user-id').value.trim();
      const accountId = document.getElementById('account-id').value.trim();
      
      if (!customerId || !externalUserId || !accountId) {
        textEl.innerHTML = '⚠️ Enter account credentials above first';
        textEl.style.color = '#666';
        statusEl.style.background = '#f5f5f5';
        return;
      }
      
      textEl.innerHTML = 'Checking...';
      textEl.style.color = '#666';
      
      try {
        const response = await fetch(
          `/api/customers/${customerId}/googleAds:search?externalUserId=${encodeURIComponent(externalUserId)}&accountId=${encodeURIComponent(accountId)}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: 'SELECT customer.id, customer.customer_agreement_setting.accepted_lead_form_terms FROM customer'
            })
          }
        );
        
        if (!response.ok) throw new Error('Failed to check ToS');
        
        const data = await response.json();
        const accepted = data.results?.[0]?.customer?.customerAgreementSetting?.acceptedLeadFormTerms;
        
        if (accepted) {
          textEl.innerHTML = '✅ <strong>Terms of Service accepted</strong> - Lead Forms can be created via API';
          textEl.style.color = '#155724';
          statusEl.style.background = '#d4edda';
        } else {
          textEl.innerHTML = '❌ <strong>Terms of Service NOT accepted</strong> - <a href="https://ads.google.com" target="_blank" style="color:#721c24;">Accept in Google Ads UI</a>';
          textEl.style.color = '#721c24';
          statusEl.style.background = '#f8d7da';
        }
      } catch (err) {
        textEl.innerHTML = '⚠️ Could not check ToS status';
        textEl.style.color = '#666';
        statusEl.style.background = '#f5f5f5';
      }
    }
    window.checkLeadFormToS = checkLeadFormToS;

    function openModal(type, title) {
      const modal = document.getElementById('detail-modal');
      document.getElementById('modal-type').textContent = type;
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-body').innerHTML = `
        <div class="modal-loading">
          <div class="spinner"></div>
          <span>Loading details...</span>
        </div>
      `;
      modal.style.display = 'block';
      requestAnimationFrame(() => modal.classList.add('visible'));
    }

    function closeModal() {
      const modal = document.getElementById('detail-modal');
      modal.classList.remove('visible');
      setTimeout(() => modal.style.display = 'none', 250);
    }

    function closeModalOnOverlay(event) {
      if (event.target.id === 'detail-modal') closeModal();
    }

    function showModalError(message) {
      document.getElementById('modal-body').innerHTML = `
        <div class="modal-error">
          <div class="modal-error-icon">⚠️</div>
          <p>${message}</p>
        </div>
      `;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      if (dateStr.length === 8) {
        return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
      }
      return dateStr;
    }

    function formatBoolean(val) {
      if (val === true) return 'Yes';
      if (val === false) return 'No';
      return 'N/A';
    }

    function renderDetailSection(title, rows) {
      const validRows = rows.filter(r => r.value !== undefined && r.value !== null && r.value !== '');
      if (validRows.length === 0) return '';
      return `
        <div class="detail-section">
          <div class="detail-section-title">${title}</div>
          ${validRows.map(r => `
            <div class="detail-row">
              <span class="detail-label">${r.label}</span>
              <span class="detail-value ${r.mono ? 'mono' : ''}">${r.value}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderDetailList(title, items) {
      if (!items || items.length === 0) return '';
      return `
        <div class="detail-section">
          <div class="detail-section-title">${title}</div>
          <ul class="detail-list">
            ${items.map(item => `<li>${item}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    async function executeGAQL(query) {
      const response = await fetch(
        `/api/customers/${selectedCustomerId}/googleAds:search?externalUserId=${encodeURIComponent(currentUserId)}&accountId=${encodeURIComponent(selectedAccountId)}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
        }
      );
      if (!response.ok) throw new Error((await response.json()).error || 'API request failed');
      return response.json();
    }

    async function showCampaignDetails(campaignId, campaignName) {
      openModal('Campaign', campaignName || `Campaign ${campaignId}`);
      try {
        const query = `
          SELECT 
            campaign.id,
            campaign.name,
            campaign.status,
            campaign.start_date,
            campaign.end_date,
            campaign.advertising_channel_type,
            campaign.advertising_channel_sub_type,
            campaign.bidding_strategy_type,
            campaign.network_settings.target_google_search,
            campaign.network_settings.target_search_network,
            campaign.network_settings.target_content_network,
            campaign.network_settings.target_partner_search_network,
            campaign.geo_target_type_setting.positive_geo_target_type,
            campaign.geo_target_type_setting.negative_geo_target_type,
            campaign.target_spend.target_spend_micros,
            campaign.url_custom_parameters,
            campaign_budget.amount_micros,
            campaign_budget.delivery_method,
            campaign_budget.period,
            campaign_budget.type,
            campaign_budget.explicitly_shared
          FROM campaign
          WHERE campaign.id = ${campaignId}
        `;
        const data = await executeGAQL(query);
        const result = (data.results || [])[0];
        
        if (!result) {
          showModalError('Campaign not found');
          return;
        }
        
        const c = result.campaign || {};
        const b = result.campaignBudget || {};
        const ns = c.networkSettings || {};
        const geo = c.geoTargetTypeSetting || {};
        const customParams = c.urlCustomParameters || [];
        
        let html = renderDetailSection('Basic Information', [
          { label: 'Campaign ID', value: c.id, mono: true },
          { label: 'Name', value: c.name },
          { label: 'Status', value: formatStatus(c.status) },
          { label: 'Start Date', value: formatDate(c.startDate) },
          { label: 'End Date', value: formatDate(c.endDate) || 'No end date' },
        ]);
        
        html += renderDetailSection('Channel Settings', [
          { label: 'Channel Type', value: c.advertisingChannelType },
          { label: 'Channel Sub-Type', value: c.advertisingChannelSubType },
          { label: 'Bidding Strategy', value: c.biddingStrategyType },
        ]);
        
        html += renderDetailSection('Budget', [
          { label: 'Daily Budget', value: formatMicros(b.amountMicros) },
          { label: 'Delivery Method', value: b.deliveryMethod },
          { label: 'Budget Period', value: b.period },
          { label: 'Budget Type', value: b.type },
          { label: 'Shared Budget', value: formatBoolean(b.explicitlyShared) },
          { label: 'Target Spend', value: c.targetSpend?.targetSpendMicros ? formatMicros(c.targetSpend.targetSpendMicros) : null },
        ]);
        
        html += renderDetailSection('Network Settings', [
          { label: 'Google Search', value: formatBoolean(ns.targetGoogleSearch) },
          { label: 'Search Network', value: formatBoolean(ns.targetSearchNetwork) },
          { label: 'Content Network', value: formatBoolean(ns.targetContentNetwork) },
          { label: 'Partner Search Network', value: formatBoolean(ns.targetPartnerSearchNetwork) },
        ]);
        
        html += renderDetailSection('Geo Target Settings', [
          { label: 'Positive Geo Target Type', value: geo.positiveGeoTargetType },
          { label: 'Negative Geo Target Type', value: geo.negativeGeoTargetType },
        ]);
        
        if (customParams.length > 0) {
          const params = customParams.map(p => `{${p.key}} = ${p.value}`);
          html += renderDetailList('URL Custom Parameters', params);
        }
        
        document.getElementById('modal-body').innerHTML = html || '<p>No additional details available.</p>';
      } catch (error) {
        showModalError(error.message);
      }
    }

    async function showAdGroupDetails(adGroupId, adGroupName) {
      openModal('Ad Group', adGroupName || `Ad Group ${adGroupId}`);
      try {
        const query = `
          SELECT 
            ad_group.id,
            ad_group.name,
            ad_group.status,
            ad_group.type,
            ad_group.cpc_bid_micros,
            ad_group.cpm_bid_micros,
            ad_group.cpv_bid_micros,
            ad_group.target_cpa_micros,
            ad_group.target_roas,
            ad_group.effective_target_cpa_micros,
            ad_group.effective_target_roas,
            ad_group.percent_cpc_bid_micros,
            ad_group.display_custom_bid_dimension,
            ad_group.final_url_suffix,
            ad_group.tracking_url_template,
            campaign.id,
            campaign.name
          FROM ad_group
          WHERE ad_group.id = ${adGroupId}
        `;
        const data = await executeGAQL(query);
        const result = (data.results || [])[0];
        
        if (!result) {
          showModalError('Ad Group not found');
          return;
        }
        
        const ag = result.adGroup || {};
        const campaign = result.campaign || {};
        
        let html = renderDetailSection('Basic Information', [
          { label: 'Ad Group ID', value: ag.id, mono: true },
          { label: 'Name', value: ag.name },
          { label: 'Status', value: formatStatus(ag.status) },
          { label: 'Type', value: ag.type },
          { label: 'Campaign', value: campaign.name },
          { label: 'Campaign ID', value: campaign.id, mono: true },
        ]);
        
        html += renderDetailSection('Bidding', [
          { label: 'CPC Bid', value: ag.cpcBidMicros ? formatMicros(ag.cpcBidMicros) : null },
          { label: 'CPM Bid', value: ag.cpmBidMicros ? formatMicros(ag.cpmBidMicros) : null },
          { label: 'CPV Bid', value: ag.cpvBidMicros ? formatMicros(ag.cpvBidMicros) : null },
          { label: 'Target CPA', value: ag.targetCpaMicros ? formatMicros(ag.targetCpaMicros) : null },
          { label: 'Effective Target CPA', value: ag.effectiveTargetCpaMicros ? formatMicros(ag.effectiveTargetCpaMicros) : null },
          { label: 'Target ROAS', value: ag.targetRoas ? `${(ag.targetRoas * 100).toFixed(0)}%` : null },
          { label: 'Effective Target ROAS', value: ag.effectiveTargetRoas ? `${(ag.effectiveTargetRoas * 100).toFixed(0)}%` : null },
          { label: 'Percent CPC Bid', value: ag.percentCpcBidMicros ? formatMicros(ag.percentCpcBidMicros) : null },
        ]);
        
        html += renderDetailSection('Tracking & Display', [
          { label: 'Display Custom Bid Dimension', value: ag.displayCustomBidDimension },
          { label: 'Final URL Suffix', value: ag.finalUrlSuffix },
          { label: 'Tracking URL Template', value: ag.trackingUrlTemplate },
        ]);
        
        document.getElementById('modal-body').innerHTML = html || '<p>No additional details available.</p>';
      } catch (error) {
        showModalError(error.message);
      }
    }

    async function showAdDetails(adId, adGroupAdResourceName) {
      openModal('Ad', `Ad ${adId}`);
      try {
        const query = `
          SELECT 
            ad_group_ad.ad.id,
            ad_group_ad.ad.type,
            ad_group_ad.ad.final_urls,
            ad_group_ad.ad.final_mobile_urls,
            ad_group_ad.ad.display_url,
            ad_group_ad.ad.tracking_url_template,
            ad_group_ad.ad.url_custom_parameters,
            ad_group_ad.ad.responsive_search_ad.headlines,
            ad_group_ad.ad.responsive_search_ad.descriptions,
            ad_group_ad.ad.responsive_search_ad.path1,
            ad_group_ad.ad.responsive_search_ad.path2,
            ad_group_ad.ad.expanded_text_ad.headline_part1,
            ad_group_ad.ad.expanded_text_ad.headline_part2,
            ad_group_ad.ad.expanded_text_ad.headline_part3,
            ad_group_ad.ad.expanded_text_ad.description,
            ad_group_ad.ad.expanded_text_ad.description2,
            ad_group_ad.ad.expanded_text_ad.path1,
            ad_group_ad.ad.expanded_text_ad.path2,
            ad_group_ad.status,
            ad_group_ad.policy_summary.approval_status,
            ad_group_ad.policy_summary.review_status,
            ad_group.id,
            ad_group.name,
            campaign.id,
            campaign.name
          FROM ad_group_ad
          WHERE ad_group_ad.ad.id = ${adId}
        `;
        const data = await executeGAQL(query);
        const result = (data.results || [])[0];
        
        if (!result) {
          showModalError('Ad not found');
          return;
        }
        
        const aga = result.adGroupAd || {};
        const ad = aga.ad || {};
        const rsa = ad.responsiveSearchAd || {};
        const eta = ad.expandedTextAd || {};
        const policy = aga.policySummary || {};
        const adGroup = result.adGroup || {};
        const campaign = result.campaign || {};
        const customParams = ad.urlCustomParameters || [];
        
        let html = renderDetailSection('Basic Information', [
          { label: 'Ad ID', value: ad.id, mono: true },
          { label: 'Ad Type', value: ad.type },
          { label: 'Status', value: formatStatus(aga.status) },
          { label: 'Ad Group', value: adGroup.name },
          { label: 'Ad Group ID', value: adGroup.id, mono: true },
          { label: 'Campaign', value: campaign.name },
          { label: 'Campaign ID', value: campaign.id, mono: true },
        ]);
        
        html += renderDetailSection('Policy Status', [
          { label: 'Approval Status', value: policy.approvalStatus },
          { label: 'Review Status', value: policy.reviewStatus },
        ]);
        
        const headlines = (rsa.headlines || []).map(h => h.text).filter(Boolean);
        if (headlines.length > 0) {
          html += renderDetailList('Headlines (Responsive Search Ad)', headlines);
        }
        
        const descriptions = (rsa.descriptions || []).map(d => d.text).filter(Boolean);
        if (descriptions.length > 0) {
          html += renderDetailList('Descriptions (Responsive Search Ad)', descriptions);
        }
        
        if (rsa.path1 || rsa.path2) {
          html += renderDetailSection('Display Path (Responsive Search Ad)', [
            { label: 'Path 1', value: rsa.path1 },
            { label: 'Path 2', value: rsa.path2 },
          ]);
        }
        
        const etaHeadlines = [eta.headlinePart1, eta.headlinePart2, eta.headlinePart3].filter(Boolean);
        if (etaHeadlines.length > 0) {
          html += renderDetailList('Headlines (Expanded Text Ad)', etaHeadlines);
        }
        
        const etaDescriptions = [eta.description, eta.description2].filter(Boolean);
        if (etaDescriptions.length > 0) {
          html += renderDetailList('Descriptions (Expanded Text Ad)', etaDescriptions);
        }
        
        if (eta.path1 || eta.path2) {
          html += renderDetailSection('Display Path (Expanded Text Ad)', [
            { label: 'Path 1', value: eta.path1 },
            { label: 'Path 2', value: eta.path2 },
          ]);
        }
        
        const finalUrls = ad.finalUrls || [];
        if (finalUrls.length > 0) {
          html += renderDetailList('Final URLs', finalUrls);
        }
        
        const finalMobileUrls = ad.finalMobileUrls || [];
        if (finalMobileUrls.length > 0) {
          html += renderDetailList('Final Mobile URLs', finalMobileUrls);
        }
        
        html += renderDetailSection('Tracking & Display', [
          { label: 'Display URL', value: ad.displayUrl },
          { label: 'Tracking URL Template', value: ad.trackingUrlTemplate },
        ]);
        
        if (customParams.length > 0) {
          const params = customParams.map(p => `{${p.key}} = ${p.value}`);
          html += renderDetailList('URL Custom Parameters', params);
        }
        
        document.getElementById('modal-body').innerHTML = html || '<p>No additional details available.</p>';
      } catch (error) {
        showModalError(error.message);
      }
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });

    // Character counter
    function updateCharCounter(input, maxLength) {
      const counter = input.parentElement.querySelector('.char-counter') || input.nextElementSibling;
      if (counter && counter.classList.contains('char-counter')) {
        const len = input.value.length;
        counter.textContent = `${len}/${maxLength}`;
        counter.classList.remove('warning', 'error');
        if (len >= maxLength) {
          counter.classList.add('error');
        } else if (len >= maxLength * 0.8) {
          counter.classList.add('warning');
        }
      }
    }

    // Add headline field
    function addHeadline() {
      const container = document.getElementById('headlines-container');
      const count = container.querySelectorAll('.headline-input').length;
      if (count >= 15) {
        alert('Maximum 15 headlines allowed');
        return;
      }
      const div = document.createElement('div');
      div.className = 'dynamic-field';
      div.innerHTML = `
        <input type="text" class="headline-input" maxlength="30" placeholder="Headline ${count + 1}" oninput="updateCharCounter(this, 30)">
        <span class="char-counter">0/30</span>
        <button type="button" class="remove-field-btn" onclick="removeField(this, 'headline')">×</button>
      `;
      container.appendChild(div);
    }

    // Add description field
    function addDescription() {
      const container = document.getElementById('descriptions-container');
      const count = container.querySelectorAll('.description-input').length;
      if (count >= 4) {
        alert('Maximum 4 descriptions allowed');
        return;
      }
      const div = document.createElement('div');
      div.className = 'dynamic-field';
      div.innerHTML = `
        <input type="text" class="description-input" maxlength="90" placeholder="Description ${count + 1}" oninput="updateCharCounter(this, 90)">
        <span class="char-counter">0/90</span>
        <button type="button" class="remove-field-btn" onclick="removeField(this, 'description')">×</button>
      `;
      container.appendChild(div);
    }

    // Remove dynamic field
    function removeField(btn, type) {
      const container = type === 'headline' ? document.getElementById('headlines-container') : document.getElementById('descriptions-container');
      const minCount = 2;
      const currentCount = container.querySelectorAll(`.${type}-input`).length;
      if (currentCount <= minCount) {
        alert(`Minimum ${minCount} ${type}s required`);
        return;
      }
      btn.parentElement.remove();
    }

    function getDisplayPathsFromUrl(urlString) {
      try {
        const url = new URL(urlString);
        const pathSegments = url.pathname.split('/').filter(s => s.length > 0);
        return {
          path1: (pathSegments[0] || '').substring(0, 15),
          path2: (pathSegments[1] || '').substring(0, 15)
        };
      } catch (e) {
        return { path1: '', path2: '' };
      }
    }

    function updateUrlPreview() {
      const domain = document.getElementById('url-domain')?.textContent || '';
      const path1 = document.getElementById('adv-path1')?.value || '';
      const path2 = document.getElementById('adv-path2')?.value || '';
      const preview = document.getElementById('url-preview');
      if (!preview) return;
      let displayUrl = domain;
      if (path1) displayUrl += '/' + path1;
      if (path2) displayUrl += '/' + path2;
      preview.textContent = 'Ad will display: ' + displayUrl;
    }

    // Create advanced campaign
    async function createAdvancedCampaign() {
      const btn = document.getElementById('adv-create-campaign-btn');
      const statusDiv = document.getElementById('adv-create-campaign-status');
      
      const campaignName = document.getElementById('adv-campaign-name').value.trim();
      const budget = parseFloat(document.getElementById('adv-budget').value);
      const status = document.getElementById('adv-status').value;
      const adGroupName = document.getElementById('adv-adgroup-name').value.trim();
      const keywordsText = document.getElementById('adv-keywords').value.trim();
      const maxCpcUsd = parseFloat(document.getElementById('adv-max-cpc').value) || 1.00;
      const finalUrl = document.getElementById('adv-final-url').value.trim();
      const paths = getDisplayPathsFromUrl(finalUrl);
      const path1 = paths.path1;
      const path2 = paths.path2;
      
      const headlines = Array.from(document.querySelectorAll('.headline-input'))
        .map(i => i.value.trim())
        .filter(v => v.length > 0);
      
      const descriptions = Array.from(document.querySelectorAll('.description-input'))
        .map(i => i.value.trim())
        .filter(v => v.length > 0);
      
      if (!campaignName) { showStatus('adv-create-campaign-status', 'Campaign name is required', 'error'); return; }
      if (!adGroupName) { showStatus('adv-create-campaign-status', 'Ad group name is required', 'error'); return; }
      if (!keywordsText) { showStatus('adv-create-campaign-status', 'At least one keyword is required', 'error'); return; }
      if (headlines.length < 2) { showStatus('adv-create-campaign-status', 'At least 2 headlines are required', 'error'); return; }
      if (descriptions.length < 2) { showStatus('adv-create-campaign-status', 'At least 2 descriptions are required', 'error'); return; }
      if (!finalUrl) { showStatus('adv-create-campaign-status', 'Final URL is required', 'error'); return; }
      
      const keywords = keywordsText.split(',').map(k => k.trim()).filter(k => k.length > 0);
      
      const requestBody = {
        externalUserId: currentUserId,
        accountId: selectedAccountId,
        campaignName: campaignName + ' ' + Date.now(),
        budgetAmountMicros: Math.round(budget * 1000000),
        status,
        adGroupName,
        keywords,
        maxCpcUsd,
        adHeadlines: headlines,
        adDescriptions: descriptions,
        finalUrl,
        displayPath1: path1,
        displayPath2: path2,
      };
      
      if (typeof gatherOptionalExtensions === 'function') {
        const optionalData = gatherOptionalExtensions();
        Object.assign(requestBody, optionalData);
      }
      
      btn.disabled = true;
      btn.textContent = 'Creating...';
      showStatus('adv-create-campaign-status', 'Creating campaign...', 'info');
      
      try {
        const response = await fetch(`/api/customers/${selectedCustomerId}/createCompleteCampaign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to create campaign');
        }
        
        showStatus('adv-create-campaign-status', `Campaign created successfully! (${data.operationsCount} operations)`, 'success');
        
        if (selectedCustomerId) {
          await loadCampaigns(selectedCustomerId);
        }
      } catch (error) {
        showStatus('adv-create-campaign-status', 'Error: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Complete Campaign';
      }
    }

    async function toggleCampaignStatus(campaignId, currentStatus) {
      const newStatus = currentStatus === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      try {
        showStatus('data-status', `Updating campaign status...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/campaigns/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              update: {
                resourceName: `customers/${selectedCustomerId}/campaigns/${campaignId}`,
                status: newStatus
              },
              updateMask: 'status'
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Campaign ${newStatus.toLowerCase()}`, 'success');
        await loadCampaigns(selectedCustomerId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function toggleAdGroupStatus(adGroupId, currentStatus) {
      const newStatus = currentStatus === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      try {
        showStatus('data-status', `Updating ad group status...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroups/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              update: {
                resourceName: `customers/${selectedCustomerId}/adGroups/${adGroupId}`,
                status: newStatus
              },
              updateMask: 'status'
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Ad group ${newStatus.toLowerCase()}`, 'success');
        await loadAdGroups(selectedCampaignId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function toggleAdStatus(adId, currentStatus, adGroupId) {
      const newStatus = currentStatus === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      try {
        showStatus('data-status', `Updating ad status...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupAds/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              update: {
                resourceName: `customers/${selectedCustomerId}/adGroupAds/${adGroupId}~${adId}`,
                status: newStatus
              },
              updateMask: 'status'
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Ad ${newStatus.toLowerCase()}`, 'success');
        await loadAds(selectedAdGroupId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function deleteCampaign(campaignId, campaignName) {
      if (!confirm(`Are you sure you want to delete campaign "${campaignName}"?\n\nThis will also delete all ad groups and ads within this campaign.`)) {
        return;
      }
      try {
        showStatus('data-status', `Deleting campaign...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/campaigns/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              remove: `customers/${selectedCustomerId}/campaigns/${campaignId}`
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Campaign deleted`, 'success');
        selectedCampaignId = null;
        selectedAdGroupId = null;
        document.getElementById('adgroups-list').innerHTML = '';
        document.getElementById('ads-list').innerHTML = '';
        await loadCampaigns(selectedCustomerId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function deleteAdGroup(adGroupId, adGroupName) {
      if (!confirm(`Are you sure you want to delete ad group "${adGroupName}"?\n\nThis will also delete all ads within this ad group.`)) {
        return;
      }
      try {
        showStatus('data-status', `Deleting ad group...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroups/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              remove: `customers/${selectedCustomerId}/adGroups/${adGroupId}`
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Ad group deleted`, 'success');
        selectedAdGroupId = null;
        document.getElementById('ads-list').innerHTML = '';
        await loadAdGroups(selectedCampaignId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    async function deleteAd(adId, adGroupId) {
      if (!confirm(`Are you sure you want to delete this ad?`)) {
        return;
      }
      try {
        showStatus('data-status', `Deleting ad...`, 'info');
        const response = await fetch(`/api/customers/${selectedCustomerId}/adGroupAds/mutate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            externalUserId: currentUserId,
            accountId: selectedAccountId,
            operations: [{
              remove: `customers/${selectedCustomerId}/adGroupAds/${adGroupId}~${adId}`
            }]
          })
        });
        if (!response.ok) throw new Error((await response.json()).error);
        showStatus('data-status', `Ad deleted`, 'success');
        await loadAds(selectedAdGroupId);
      } catch (error) {
        showStatus('data-status', `Error: ${error.message}`, 'error');
      }
    }

    function togglePromoDiscount() {
      const type = document.getElementById('promo-discount-type').value;
      document.getElementById('promo-money-fields').style.display = type === 'money' ? 'block' : 'none';
      document.getElementById('promo-percent-fields').style.display = type === 'percent' ? 'block' : 'none';
    }

    function togglePromoDetails() {
      const type = document.getElementById('promo-details-type').value;
      document.getElementById('promo-code-field').style.display = type === 'code' ? 'block' : 'none';
      document.getElementById('promo-min-order-field').style.display = type === 'minimum' ? 'block' : 'none';
    }

    function addPriceOffering() {
      const container = document.getElementById('price-offerings-container');
      const count = container.querySelectorAll('.price-offering').length;
      if (count >= 8) {
        alert('Maximum 8 price offerings allowed');
        return;
      }
      const div = document.createElement('div');
      div.className = 'price-offering';
      div.style.cssText = 'border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px; position:relative;';
      div.innerHTML = `
        <button type="button" class="remove-field-btn" onclick="this.parentElement.remove()" style="position:absolute; top:8px; right:8px;">×</button>
        <div class="grid">
          <div>
            <label>Header</label>
            <input type="text" class="price-header" maxlength="25" placeholder="Plan Name" oninput="updateCharCounter(this, 25)">
            <div class="char-counter">0/25</div>
          </div>
          <div>
            <label>Description</label>
            <input type="text" class="price-description" maxlength="25" placeholder="Description" oninput="updateCharCounter(this, 25)">
            <div class="char-counter">0/25</div>
          </div>
        </div>
        <div class="grid" style="margin-top:8px;">
          <div>
            <label>Price</label>
            <input type="number" class="price-amount" step="0.01" min="0" placeholder="19.99">
          </div>
          <div>
            <label>Currency</label>
            <select class="price-currency">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="ILS">ILS</option>
            </select>
          </div>
          <div>
            <label>Unit</label>
            <select class="price-unit">
              <option value="">None</option>
              <option value="PER_HOUR">Per Hour</option>
              <option value="PER_DAY">Per Day</option>
              <option value="PER_WEEK">Per Week</option>
              <option value="PER_MONTH">Per Month</option>
              <option value="PER_YEAR">Per Year</option>
              <option value="PER_NIGHT">Per Night</option>
            </select>
          </div>
        </div>
        <div style="margin-top:8px;">
          <label>Offering URL</label>
          <input type="url" class="price-url" placeholder="https://example.com/pricing">
        </div>
      `;
      container.appendChild(div);
    }

    function addCallout() {
      const container = document.getElementById('callouts-container');
      const div = document.createElement('div');
      div.className = 'callout-item';
      div.style.cssText = 'border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px; position:relative;';
      div.innerHTML = `
        <button type="button" class="remove-field-btn" onclick="this.parentElement.remove()" style="position:absolute; top:8px; right:8px;">×</button>
        <div class="dynamic-field">
          <input type="text" class="callout-input" maxlength="25" placeholder="Callout text" oninput="updateCharCounter(this, 25)">
          <span class="char-counter">0/25</span>
        </div>
        <div class="grid" style="margin-top:8px;">
          <div>
            <label style="font-size:12px;">Start Date (optional)</label>
            <input type="date" class="callout-start-date">
          </div>
          <div>
            <label style="font-size:12px;">End Date (optional)</label>
            <input type="date" class="callout-end-date">
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    function addSitelink() {
      const container = document.getElementById('sitelinks-container');
      const newItem = document.createElement('div');
      newItem.className = 'sitelink-item';
      newItem.style = 'border:1px solid #ddd; padding:12px; border-radius:4px; margin-bottom:8px;';
      newItem.innerHTML = `
        <div class="grid">
          <div>
            <label>Link Text</label>
            <input type="text" class="sitelink-text" maxlength="25" placeholder="Link Text" oninput="updateCharCounter(this, 25)">
            <span class="char-counter">0/25</span>
          </div>
          <div>
            <label>Final URL</label>
            <input type="url" class="sitelink-url" placeholder="https://example.com/page">
          </div>
        </div>
        <div class="grid" style="margin-top:8px;">
          <div>
            <label>Description Line 1 (optional)</label>
            <input type="text" class="sitelink-desc1" maxlength="35" placeholder="Description line 1" oninput="updateCharCounter(this, 35)">
            <span class="char-counter">0/35</span>
          </div>
          <div>
            <label>Description Line 2 (optional)</label>
            <input type="text" class="sitelink-desc2" maxlength="35" placeholder="Description line 2" oninput="updateCharCounter(this, 35)">
            <span class="char-counter">0/35</span>
          </div>
        </div>
        <button type="button" onclick="this.parentElement.remove()" style="margin-top:8px;background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">Remove</button>
      `;
      container.appendChild(newItem);
    }

    function gatherOptionalExtensions() {
      const data = {};
      
      const promoTarget = document.getElementById('promo-target').value.trim();
      const promoFinalUrl = document.getElementById('promo-final-url').value.trim();
      const promoDiscountType = document.getElementById('promo-discount-type').value;
      
      if (promoTarget || promoFinalUrl || promoDiscountType) {
        data.promotion = {
          promotionTarget: promoTarget,
          languageCode: document.getElementById('promo-language').value || 'en',
          finalUrl: promoFinalUrl || undefined,
          occasion: document.getElementById('promo-occasion').value || undefined,
          redemptionStartDate: document.getElementById('promo-start-date').value || undefined,
          redemptionEndDate: document.getElementById('promo-end-date').value || undefined,
        };
        
        const currency = document.getElementById('promo-currency').value || 'USD';
        
        if (promoDiscountType === 'money') {
          const amount = parseFloat(document.getElementById('promo-money-amount').value);
          if (amount > 0) {
            data.promotion.moneyAmountOff = { amount, currencyCode: currency };
          }
        } else if (promoDiscountType === 'percent') {
          const percent = parseInt(document.getElementById('promo-percent').value);
          if (percent > 0) {
            data.promotion.percentOff = percent;
          }
        }
        
        const promoDetailsType = document.getElementById('promo-details-type').value;
        if (promoDetailsType === 'code') {
          data.promotion.promotionCode = document.getElementById('promo-code').value.trim() || undefined;
        } else if (promoDetailsType === 'minimum') {
          const minOrder = parseFloat(document.getElementById('promo-min-order').value);
          if (minOrder > 0) {
            data.promotion.ordersOverAmount = { amount: minOrder, currencyCode: currency };
          }
        }
      }
      
      const priceType = document.getElementById('price-type').value;
      if (priceType) {
        const offerings = [];
        document.querySelectorAll('.price-offering').forEach(offering => {
          const header = offering.querySelector('.price-header').value.trim();
          const description = offering.querySelector('.price-description').value.trim();
          const amount = parseFloat(offering.querySelector('.price-amount').value);
          const url = offering.querySelector('.price-url').value.trim();
          
          if (header && description && amount > 0 && url) {
            offerings.push({
              header,
              description,
              price: {
                amount,
                currencyCode: offering.querySelector('.price-currency').value
              },
              finalUrl: url,
              unit: offering.querySelector('.price-unit').value || undefined
            });
          }
        });
        
        if (offerings.length >= 3) {
          data.prices = {
            type: priceType,
            priceQualifier: document.getElementById('price-qualifier').value || undefined,
            languageCode: document.getElementById('price-language').value || 'en',
            offerings
          };
        }
      }
      
      const phoneNumber = document.getElementById('call-phone').value.trim();
      if (phoneNumber) {
        data.call = {
          countryCode: document.getElementById('call-country').value || 'US',
          phoneNumber
        };
      }
      
      const calloutItems = document.querySelectorAll('.callout-item');
      const callouts = [];
      calloutItems.forEach(item => {
        const text = item.querySelector('.callout-input').value.trim();
        if (text) {
          const callout = { text };
          const startDate = item.querySelector('.callout-start-date')?.value;
          const endDate = item.querySelector('.callout-end-date')?.value;
          if (startDate) callout.startDate = startDate;
          if (endDate) callout.endDate = endDate;
          callouts.push(callout);
        }
      });
      if (callouts.length > 0) {
        data.callouts = callouts;
      }
      
      const sitelinkItems = document.querySelectorAll('.sitelink-item');
      const sitelinks = [];
      sitelinkItems.forEach(item => {
        const text = item.querySelector('.sitelink-text').value.trim();
        const url = item.querySelector('.sitelink-url').value.trim();
        if (text && url) {
          const sitelink = {
            text,
            finalUrl: url
          };
          const desc1 = item.querySelector('.sitelink-desc1')?.value.trim();
          const desc2 = item.querySelector('.sitelink-desc2')?.value.trim();
          if (desc1) sitelink.description1 = desc1;
          if (desc2) sitelink.description2 = desc2;
          sitelinks.push(sitelink);
        }
      });
      if (sitelinks.length > 0) {
        data.sitelinks = sitelinks;
      }
      
      const leadBusiness = document.getElementById('lead-business').value.trim();
      const leadHeadline = document.getElementById('lead-headline').value.trim();
      const leadPrivacy = document.getElementById('lead-privacy-url').value.trim();
      if (leadBusiness && leadHeadline && leadPrivacy) {
        const fields = Array.from(document.querySelectorAll('.lead-field:checked'))
          .map(cb => cb.value);
        
        data.leadForm = {
          businessName: leadBusiness,
          headline: leadHeadline,
          description: document.getElementById('lead-description').value.trim(),
          privacyPolicyUrl: leadPrivacy,
          callToActionType: document.getElementById('lead-cta-type').value,
          callToActionDescription: document.getElementById('lead-cta-desc').value.trim(),
          postSubmitHeadline: document.getElementById('lead-post-headline').value.trim() || undefined,
          postSubmitDescription: document.getElementById('lead-post-desc').value.trim() || undefined,
          fields
        };
      }
      
      const appStore = document.getElementById('app-store').value;
      const appId = document.getElementById('app-id').value.trim();
      const appLinkText = document.getElementById('app-link-text').value.trim();
      if (appStore && appId && appLinkText) {
        data.app = {
          appStore,
          appId,
          linkText: appLinkText
        };
      }
      
      return data;
    }
  </script>
</body>
</html>
